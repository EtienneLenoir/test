Function SommeValeursParLabelPourISIN(dico As Object, label As String, ISIN As String) As Variant
    Dim dicoISIN As Object
    Dim tableauCaracteristiques As Variant
    Dim i As Long
    Dim total As Double
    Dim labelTrouve As Boolean
    Dim indexColonne As Long

    total = 0 ' Initialiser la somme totale

    ' Parcourir chaque NumId dans le dictionnaire principal
    For Each NumID In dico.Keys
        ' Vérifier si le dictionnaire imbriqué pour le NumId a l'ISIN
        If dico(NumID).Exists(ISIN) Then
            ' Obtenir le dictionnaire imbriqué pour l'ISIN
            Set dicoISIN = dico(NumID)

            ' Obtenir le tableau de caractéristiques pour l'ISIN
            tableauCaracteristiques = dicoISIN(ISIN)

            ' Initialiser labelTrouve à False
            labelTrouve = False
            
            ' Trouver l'index de la colonne correspondant au label
            For i = LBound(tableauCaracteristiques, 2) To UBound(tableauCaracteristiques, 2)
                If tableauCaracteristiques(1, i) = label Then
                    indexColonne = i
                    labelTrouve = True
                    Exit For
                End If
            Next i
            
            ' Si le label a été trouvé, ajouter la valeur à la somme totale
            If labelTrouve Then
                total = total + tableauCaracteristiques(2, indexColonne) ' 2 pour la ligne de valeurs
            End If
        End If
    Next NumID

    ' Retourner la somme totale
    SommeValeursParLabelPourISIN = total
End Function



Sub ChargerDonneesFiltreesAvecFiltreAutomatique()

    Dim ws As Worksheet
    Dim DerniereLigne As Long
    Dim DonneesFiltrees As Variant
    Dim PlageFiltre As Range

    ' Définir la feuille de calcul
    Set ws = ThisWorkbook.Sheets("NomDeVotreFeuille")
    
    ' Trouver la dernière ligne avec des données dans la colonne A (ajuster selon vos besoins)
    DerniereLigne = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    
    ' Appliquer le filtre automatique sur la plage
    ws.Range("A1:A" & DerniereLigne).AutoFilter Field:=1, Criteria1:=">10" ' Changez le critère selon vos besoins

    ' Définir la plage filtrée
    On Error Resume Next ' Pour éviter l'erreur si aucune cellule visible
    Set PlageFiltre = ws.Range("A1:A" & DerniereLigne).SpecialCells(xlCellTypeVisible)
    On Error GoTo 0 ' Réinitialiser le gestionnaire d'erreurs

    ' Vérifier si des cellules visibles existent après le filtre
    If Not PlageFiltre Is Nothing Then
        ' Remplir le tableau avec les valeurs visibles
        DonneesFiltrees = Application.Transpose(PlageFiltre.Value)
    Else
        MsgBox "Aucune donnée ne correspond aux critères de filtrage."
        Exit Sub
    End If

    ' Désactiver le filtre
    ws.AutoFilterMode = False

    ' Afficher les données filtrées (pour vérification)
    Dim i As Long
    For i = LBound(DonneesFiltrees) To UBound(DonneesFiltrees)
        Debug.Print DonneesFiltrees(i) ' Afficher dans la fenêtre d'exécution
    Next i

End Sub


Function GetValueFromDictionnaire(dico As Object, NumId As Variant, ISIN As Variant, label As String) As Variant
    Dim dicoISIN As Object
    Dim tableauCaracteristiques As Variant
    Dim i As Long
    Dim labelTrouve As Boolean
    Dim indexColonne As Long
    
    ' Vérifier si NumId existe dans le dictionnaire
    If Not dico.Exists(NumId) Then
        GetValueFromDictionnaire = "NumId non trouvé"
        Exit Function
    End If

    ' Obtenir le dictionnaire pour ce NumId
    Set dicoISIN = dico(NumId)
    
    ' Vérifier si ISIN existe dans le dictionnaire
    If Not dicoISIN.Exists(ISIN) Then
        GetValueFromDictionnaire = "ISIN non trouvé"
        Exit Function
    End If

    ' Obtenir le tableau de caractéristiques
    tableauCaracteristiques = dicoISIN(ISIN)
    
    ' Trouver l'index de la colonne correspondant au label
    labelTrouve = False
    For i = LBound(tableauCaracteristiques, 2) To UBound(tableauCaracteristiques, 2)
        If tableauCaracteristiques(1, i) = label Then
            indexColonne = i
            labelTrouve = True
            Exit For
        End If
    Next i
    
    ' Retourner la valeur si le label a été trouvé
    If labelTrouve Then
        GetValueFromDictionnaire = tableauCaracteristiques(2, indexColonne) ' 2 pour la ligne de valeurs
    Else
        GetValueFromDictionnaire = "Label non trouvé"
    End If
End Function

