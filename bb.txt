' ====== Enrichissement feuille (FAST + VUES CONFIGURABLES, sans Do...EOF) ======
' Param "viewOrMode" (optionnel) :
'   - "STANDARD" (défaut) = même rendu que votre code actuel (BOTH : FLUX pour DEB/NBJ + Archive (jour feuille) pour FIN)
'   - "FLUX" / "ARCHIVE" / "BOTH" pour forcer la source tout en gardant l’ordre standard
'   - ou un NOM DE VUE défini dans BuildViewRegistry() (ex. "FULL"), ou via la feuille _Enrich_Config
'
' Feuille _Enrich_Config (optionnelle) :
'   - ligne "MODE" (ou "MODE:<val>") pour fixer FLUX/ARCHIVE/BOTH
'   - ligne "VIEW" (ou "VIEW:<nom>") pour choisir une vue du registre
'   - liste de lignes activées (Enabled=1) pour définir un ORDRE personnalisé :
'       * SourceKey ∈ { NBJ_VG, DEB_VG, FIN_VG, NBJ_AM, DEB_AM, FIN_AM, NBJ_SL, DEB_SL, FIN_SL, NA,
'                       SHEET:<HeaderFeuille>, FLUX:<ChampFlux>, ARC:<ChampArchive> }
'       * Header = libellé dans la feuille
Public Sub EnrichSheetFromFlux_3in1(ByVal dbPath As String, ByVal ws As Worksheet, Optional ByVal viewOrMode As String = "STANDARD")

    ' --- mapping colonnes existantes ---
    Dim map As Object: Set map = CreateObject("Scripting.Dictionary")
    MapCol map, ws, COL_BOOKING
    MapCol map, ws, COL_DOSSIER
    MapCol map, ws, COL_CONSO
    MapCol map, ws, COL_LIMITE

    ' --- bornes ---
    Dim lastRow As Long: lastRow = ws.Cells(ws.Rows.Count, map(COL_BOOKING)).End(xlUp).Row
    If lastRow < 2 Then Exit Sub
    Dim n As Long: n = lastRow - 1

    ' --- date de prod détectée sur la feuille (sert aux FIN_* depuis l'archive) ---
    Dim prodDateSheet As Variant
    prodDateSheet = DetectSheetProductionDate(ws)

    ' --- vue / mode (STANDARD par défaut) ---
    Dim order As Collection, extraFluxFields As Collection, extraArcFields As Collection
    Dim sourceMode As String, viewName As String
    Set order = New Collection
    Set extraFluxFields = New Collection
    Set extraArcFields = New Collection
    ResolveViewAndOrder viewOrMode, order, extraFluxFields, extraArcFields, sourceMode, viewName

    ' --- possibilité de surcharger par _Enrich_Config (prioritaire) ---
    TryOverrideFromSheet order, extraFluxFields, extraArcFields, sourceMode, viewName

    ' --- déduire booleans de chargement selon mode ---
    Dim useFlux As Boolean, useArc As Boolean
    Select Case UCase$(Trim$(sourceMode))
        Case "FLUX":    useFlux = True:  useArc = False
        Case "ARCHIVE": useFlux = False: useArc = True
        Case Else:      useFlux = True:  useArc = True ' BOTH
    End Select

    ' --- snapshot combiné (Flux + Archive filtrée) + extras FLUX/ARC demandés ---
    Dim snap As Object
    Set snap = LoadEnrichmentSnapshot(dbPath, prodDateSheet, extraFluxFields, extraArcFields, useFlux, useArc) ' Dict key -> info (sub-dict)

    ' --- lecture des colonnes de la feuille en mémoire ---
    Dim arrBk As Variant, arrNdc As Variant, arrConso As Variant, arrLim As Variant
    arrBk = ws.Range(ws.Cells(2, map(COL_BOOKING)), ws.Cells(lastRow, map(COL_BOOKING))).Value2
    arrNdc = ws.Range(ws.Cells(2, map(COL_DOSSIER)), ws.Cells(lastRow, map(COL_DOSSIER))).Value2
    arrConso = ws.Range(ws.Cells(2, map(COL_CONSO)), ws.Cells(lastRow, map(COL_CONSO))).Value2
    arrLim = ws.Range(ws.Cells(2, map(COL_LIMITE)), ws.Cells(lastRow, map(COL_LIMITE))).Value2

    ' --- buffers de sortie standard ---
    Dim oNBJ_VG() As Variant, oDEB_VG() As Variant, oFIN_VG() As Variant
    Dim oNBJ_AM() As Variant, oDEB_AM() As Variant, oFIN_AM() As Variant
    Dim oNBJ_SL() As Variant, oDEB_SL() As Variant, oFIN_SL() As Variant
    Dim oNA() As Variant

    ReDim oNBJ_VG(1 To n, 1 To 1): ReDim oDEB_VG(1 To n, 1 To 1): ReDim oFIN_VG(1 To n, 1 To 1)
    ReDim oNBJ_AM(1 To n, 1 To 1): ReDim oDEB_AM(1 To n, 1 To 1): ReDim oFIN_AM(1 To n, 1 To 1)
    ReDim oNBJ_SL(1 To n, 1 To 1): ReDim oDEB_SL(1 To n, 1 To 1): ReDim oFIN_SL(1 To n, 1 To 1)
    ReDim oNA(1 To n, 1 To 1)

    ' --- remplissage en mémoire ---
    Dim i As Long, k As String
    For i = 1 To n
        k = MakeKey(arrBk(i, 1), arrNdc(i, 1))

        ' NA calculée localement sur la feuille (affichage du jour de la feuille)
        If Abs(NzDbl(arrConso(i, 1))) > NzDbl(arrLim(i, 1)) Then
            oNA(i, 1) = "YES"
        Else
            oNA(i, 1) = "NO"
        End If

        If snap.Exists(k) Then
            Dim info As Object, fix As Variant, arc As Variant
            Set info = snap(k)
            fix = info("FIX")   ' 9 slots : 0..8 (Start/NBJ par nature + End 6..8 initialisés vides)
            arc = info("ARC")   ' 9 slots : Start/Duree/End par nature (depuis Archive)

            Select Case UCase$(sourceMode)
                Case "FLUX"
                    ' VG
                    oDEB_VG(i, 1) = fix(0): oNBJ_VG(i, 1) = fix(1): oFIN_VG(i, 1) = Empty
                    ' AM
                    oDEB_AM(i, 1) = fix(2): oNBJ_AM(i, 1) = fix(3): oFIN_AM(i, 1) = Empty
                    ' SL
                    oDEB_SL(i, 1) = fix(4): oNBJ_SL(i, 1) = fix(5): oFIN_SL(i, 1) = Empty

                Case "ARCHIVE"
                    ' VG
                    oDEB_VG(i, 1) = arc(0): oNBJ_VG(i, 1) = arc(1): oFIN_VG(i, 1) = arc(6)
                    ' AM
                    oDEB_AM(i, 1) = arc(2): oNBJ_AM(i, 1) = arc(3): oFIN_AM(i, 1) = arc(7)
                    ' SL
                    oDEB_SL(i, 1) = arc(4): oNBJ_SL(i, 1) = arc(5): oFIN_SL(i, 1) = arc(8)

                Case Else ' BOTH (standard historique)
                    ' VG
                    oDEB_VG(i, 1) = IIf(IsEmpty(fix(0)) Or IsNull(fix(0)), arc(0), fix(0))
                    oNBJ_VG(i, 1) = IIf(IsEmpty(fix(1)) Or IsNull(fix(1)), arc(1), fix(1))
                    oFIN_VG(i, 1) = arc(6)
                    ' AM
                    oDEB_AM(i, 1) = IIf(IsEmpty(fix(2)) Or IsNull(fix(2)), arc(2), fix(2))
                    oNBJ_AM(i, 1) = IIf(IsEmpty(fix(3)) Or IsNull(fix(3)), arc(3), fix(3))
                    oFIN_AM(i, 1) = arc(7)
                    ' SL
                    oDEB_SL(i, 1) = IIf(IsEmpty(fix(4)) Or IsNull(fix(4)), arc(4), fix(4))
                    oNBJ_SL(i, 1) = IIf(IsEmpty(fix(5)) Or IsNull(fix(5)), arc(5), fix(5))
                    oFIN_SL(i, 1) = arc(8)
            End Select
        End If
    Next i

    ' --- dictionnaire "sourceKey standard" -> tableau résultat ---
    Dim buckets As Object: Set buckets = CreateObject("Scripting.Dictionary")
    buckets.CompareMode = 1
    buckets("NBJ_VG") = oNBJ_VG: buckets("DEB_VG") = oDEB_VG: buckets("FIN_VG") = oFIN_VG
    buckets("NBJ_AM") = oNBJ_AM: buckets("DEB_AM") = oDEB_AM: buckets("FIN_AM") = oFIN_AM
    buckets("NBJ_SL") = oNBJ_SL: buckets("DEB_SL") = oDEB_SL: buckets("FIN_SL") = oFIN_SL
    buckets("NA") = oNA

    ' --- cache pour les colonnes copiées depuis la feuille (SHEET:...) ---
    Dim sheetCache As Object: Set sheetCache = CreateObject("Scripting.Dictionary")
    sheetCache.CompareMode = 1

    ' --- écriture en bloc selon l'ordre configuré ---
    Dim pair As Variant, sourceKey As String, headerText As String, colIdx As Long
    Dim fld As String, outDyn() As Variant

    For Each pair In order
        sourceKey = CStr(pair(0))
        headerText = CStr(pair(1))

        ' 6.a) colonnes standard pré-calculées
        If buckets.Exists(sourceKey) Then
            colIdx = EnsureColumn(ws, headerText)
            ws.Cells(2, colIdx).Resize(n, 1).Value2 = buckets(sourceKey)
            Select Case sourceKey
                Case "NBJ_VG", "NBJ_AM", "NBJ_SL": ws.Columns(colIdx).NumberFormat = "0"
                Case "DEB_VG", "DEB_AM", "DEB_SL", "FIN_VG", "FIN_AM", "FIN_SL": ws.Columns(colIdx).NumberFormat = "dd/mm/yyyy"
            End Select
            GoTo NextPair
        End If

        ' 6.b) colonnes directes de la feuille (SHEET:<HeaderExact>)
        If Left$(sourceKey, 6) = "SHEET:" Then
            Dim srcHdr As String: srcHdr = Mid$(sourceKey, 7)
            Dim arrCol As Variant
            If Not sheetCache.Exists(srcHdr) Then
                Dim col As Long: col = FindHeader(ws, srcHdr)
                If col = 0 Then GoTo NextPair
                arrCol = ws.Cells(2, col).Resize(n, 1).Value2
                sheetCache(srcHdr) = arrCol
            End If
            colIdx = EnsureColumn(ws, headerText)
            ws.Cells(2, colIdx).Resize(n, 1).Value2 = sheetCache(srcHdr)
            GoTo NextPair
        End If

        ' 6.c) champs dynamiques issus de FLUX (FLUX:<NomChamp>)
        If Left$(sourceKey, 5) = "FLUX:" Then
            fld = Mid$(sourceKey, 6)
            ReDim outDyn(1 To n, 1 To 1)
            For i = 1 To n
                k = MakeKey(arrBk(i, 1), arrNdc(i, 1))
                If snap.Exists(k) Then
                    Dim info2 As Object: Set info2 = snap(k)
                    If info2.Exists("FLUX:" & fld) Then outDyn(i, 1) = info2("FLUX:" & fld)
                End If
            Next i
            colIdx = EnsureColumn(ws, headerText)
            ws.Cells(2, colIdx).Resize(n, 1).Value2 = outDyn
            GoTo NextPair
        End If

        ' 6.d) champs dynamiques issus de l'ARCHIVE (ARC:<NomChamp>)
        If Left$(sourceKey, 4) = "ARC:" Then
            fld = Mid$(sourceKey, 5)
            ReDim outDyn(1 To n, 1 To 1)
            For i = 1 To n
                k = MakeKey(arrBk(i, 1), arrNdc(i, 1))
                If snap.Exists(k) Then
                    Dim info3 As Object: Set info3 = snap(k)
                    If info3.Exists("ARC:" & fld) Then outDyn(i, 1) = info3("ARC:" & fld)
                End If
            Next i
            colIdx = EnsureColumn(ws, headerText)
            ws.Cells(2, colIdx).Resize(n, 1).Value2 = outDyn
            GoTo NextPair
        End If

NextPair:
    Next pair

End Sub


' --- Résout la vue & l'ordre : argument utilisateur + registre interne
Private Sub ResolveViewAndOrder(ByVal viewOrMode As String, _
                                ByRef order As Collection, _
                                ByRef extraFluxFields As Collection, _
                                ByRef extraArcFields As Collection, _
                                ByRef sourceMode As String, _
                                ByRef viewName As String)
    Dim s As String: s = UCase$(Trim$(viewOrMode))
    Dim registry As Object: Set registry = BuildViewRegistry()

    If s = "FLUX" Or s = "ARCHIVE" Or s = "BOTH" Then
        sourceMode = s
        viewName = "STANDARD"
    ElseIf registry.Exists(s) Then
        ' appliquer la vue nommée
        ApplyView registry, s, order, extraFluxFields, extraArcFields, sourceMode, viewName
    Else
        ' fallback : STANDARD BOTH
        sourceMode = "BOTH"
        viewName = "STANDARD"
        ApplyView registry, viewName, order, extraFluxFields, extraArcFields, sourceMode, viewName
    End If
End Sub

' --- Registre des vues prêtes à l'emploi (tu peux en ajouter ici)
Private Function BuildViewRegistry() As Object
    Dim R As Object: Set R = CreateObject("Scripting.Dictionary")
    R.CompareMode = 1

    ' === STANDARD (ta vue actuelle) ===
    Dim vStd As Object: Set vStd = CreateObject("Scripting.Dictionary")
    vStd("Mode") = "BOTH" ' FLUX pour DEB/NBJ + Archive(jour feuille) pour FIN
    Dim ordStd As New Collection
    ordStd.Add Array("NBJ_VG", COL_NBJ_VG)
    ordStd.Add Array("DEB_VG", COL_DEB_VG)
    ordStd.Add Array("FIN_VG", COL_FIN_VG)
    ordStd.Add Array("NBJ_AM", COL_NBJ_AM)
    ordStd.Add Array("DEB_AM", COL_DEB_AM)
    ordStd.Add Array("FIN_AM", COL_FIN_AM)
    ordStd.Add Array("NBJ_SL", COL_NBJ_SL)
    ordStd.Add Array("DEB_SL", COL_DEB_SL)
    ordStd.Add Array("FIN_SL", COL_FIN_SL)
    ordStd.Add Array("NA", COL_FLAG_NA)
    Set vStd("Order") = ordStd
    Set vStd("FluxExtras") = New Collection ' none
    Set vStd("ArcExtras") = New Collection  ' none
    R("STANDARD") = vStd

    ' === FULL (exemple : ajoute quelques champs infos) ===
    Dim vFull As Object: Set vFull = CreateObject("Scripting.Dictionary")
    vFull("Mode") = "BOTH"
    Dim ordFull As New Collection
    Dim fe As New Collection, ae As New Collection
    ' ordre = standard + extras
    Dim p As Variant
    For Each p In ordStd: ordFull.Add p: Next p
    ' extras issus de FLUX
    ordFull.Add Array("FLUX:Limite", "Limite (Flux)")
    ordFull.Add Array("FLUX:Consommation", "Consommation (Flux)")
    ordFull.Add Array("FLUX:[Montant VG]", "Montant VG (Flux)")
    ordFull.Add Array("FLUX:[Montant AM]", "Montant AM (Flux)")
    ordFull.Add Array("FLUX:[Montant SL]", "Montant SL (Flux)")
    fe.Add "Limite": fe.Add "Consommation": fe.Add "[Montant VG]": fe.Add "[Montant AM]": fe.Add "[Montant SL]"
    ' extras issus de l'Archive (ligne du jour de FIN)
    ordFull.Add Array("ARC:DepassementNA", "Dépassement NA (Arc)")
    ordFull.Add Array("ARC:[Production Date]", "Prod Date (Arc)")
    ae.Add "DepassementNA": ae.Add "[Production Date]"
    Set vFull("Order") = ordFull
    Set vFull("FluxExtras") = fe
    Set vFull("ArcExtras") = ae
    R("FULL") = vFull

    Set BuildViewRegistry = R
End Function

' --- Applique une vue du registre
Private Sub ApplyView(ByVal registry As Object, ByVal name As String, _
                      ByRef order As Collection, ByRef extraFluxFields As Collection, _
                      ByRef extraArcFields As Collection, ByRef sourceMode As String, _
                      ByRef viewName As String)
    Dim V As Object: Set V = registry(name)
    Dim it As Variant
    Set order = New Collection
    For Each it In V("Order"): order.Add it: Next it

    Set extraFluxFields = New Collection
    If Not V("FluxExtras") Is Nothing Then
        For Each it In V("FluxExtras"): extraFluxFields.Add it: Next it
    End If

    Set extraArcFields = New Collection
    If Not V("ArcExtras") Is Nothing Then
        For Each it In V("ArcExtras"): extraArcFields.Add it: Next it
    End If

    sourceMode = V("Mode")
    viewName = name
End Sub

' --- Surcharge optionnelle via feuille "_Enrich_Config"
' Colonnes:
'   A: Enabled (1/TRUE)
'   B: SourceKey  (NBJ_VG, DEB_AM, FIN_SL, NA, SHEET:MonEntete, FLUX:NomChampFlux, ARC:NomChampArc, ...)
'   C: Header     (intitulé voulu en feuille)
' Lignes spéciales (B):
'   - "MODE"  (C = FLUX/ARCHIVE/BOTH)   ou "MODE:<valeur>"
'   - "VIEW"  (C = NomDeVue)            ou "VIEW:<NomDeVue>"
Private Sub TryOverrideFromSheet(ByRef order As Collection, _
                                 ByRef extraFluxFields As Collection, _
                                 ByRef extraArcFields As Collection, _
                                 ByRef sourceMode As String, _
                                 ByRef viewName As String)
    On Error Resume Next
    Dim w As Worksheet: Set w = ThisWorkbook.Worksheets("_Enrich_Config")
    On Error GoTo 0
    If w Is Nothing Then Exit Sub

    Dim ur As Range: Set ur = w.UsedRange
    If ur.Rows.Count < 2 Then Exit Sub

    Dim tmp As New Collection
    Dim r As Long, enabled As Variant, src As String, hdr As String

    For r = 2 To ur.Rows.Count
        enabled = ur.Cells(r, 1).Value
        src = Trim$(CStr(ur.Cells(r, 2).Value))
        hdr = Trim$(CStr(ur.Cells(r, 3).Value))

        If Len(src) = 0 Then GoTo NextRow

        ' MODE
        If UCase$(Left$(src, 5)) = "MODE:" Then
            sourceMode = Mid$(src, 6)
        ElseIf UCase$(src) = "MODE" And Len(hdr) > 0 Then
            sourceMode = hdr
        End If

        ' VIEW
        If UCase$(Left$(src, 5)) = "VIEW:" Then
            viewName = Mid$(src, 6)
        ElseIf UCase$(src) = "VIEW" And Len(hdr) > 0 Then
            viewName = hdr
        End If

        ' Lignes d'affichage (si Enabled)
        If CBool(Val(IIf(IsEmpty(enabled), 0, enabled))) Or UCase$(CStr(enabled)) = "TRUE" Then
            If Len(hdr) = 0 Then hdr = src
            tmp.Add Array(src, hdr)

            ' collecte des champs extras pour SELECT dynamiques
            If Left$(src, 5) = "FLUX:" Then
                Dim f As String: f = Mid$(src, 6)
                If Len(f) > 0 Then extraFluxFields.Add f
            ElseIf Left$(src, 4) = "ARC:" Then
                Dim a As String: a = Mid$(src, 5)
                If Len(a) > 0 Then extraArcFields.Add a
            End If
        End If
NextRow:
    Next r

    If tmp.Count > 0 Then Set order = tmp
End Sub


' --- Snapshot combiné : Flux + Archive filtrée (1 requête) + extras FLUX/ARC ---
'     - Zéro Do...EOF
'     - GetRows avec COUNT(*) optionnel
Private Function LoadEnrichmentSnapshot(ByVal dbPath As String, ByVal endDate As Variant, _
                                        ByVal extraFluxFields As Collection, ByVal extraArcFields As Collection, _
                                        ByVal useFlux As Boolean, ByVal useArchive As Boolean) As Object
    Dim cn As Object: Set cn = GetConn(dbPath)
    Dim D As Object: Set D = CreateObject("Scripting.Dictionary")
    D.CompareMode = 1 ' TextCompare

    Dim sql As String, cnt As String, v As Variant, i As Long

    ' ===== 1) FLUX =====
    If useFlux Then
        Dim selectExtrasF As String: selectExtrasF = BuildFieldList(extraFluxFields)
        sql = "SELECT Booking, [NO DOSSIER CREDIT]," & _
              " VG_StartDate, VG_NbJoursRetard," & _
              " AM_StartDate, AM_NbJoursRetard," & _
              " SL_StartDate, SL_NbJoursRetard" & selectExtrasF & _
              " FROM " & T_FLUX
        cnt = "SELECT COUNT(*) FROM " & T_FLUX

        v = RSGetRowsFast(cn, sql, cnt)
        If ArrayHasRows2D(v) Then
            Const F_BK = 0, F_NDC = 1, F_VG_START = 2, F_VG_NBJ = 3, F_AM_START = 4, F_AM_NBJ = 5, F_SL_START = 6, F_SL_NBJ = 7
            Dim baseExtra As Long: baseExtra = 8
            For i = 0 To UBound(v, 2)
                Dim k As String: k = MakeKey(v(F_BK, i), v(F_NDC, i))
                Dim info As Object
                If D.Exists(k) Then
                    Set info = D(k)
                Else
                    Set info = CreateObject("Scripting.Dictionary")
                    info.CompareMode = 1
                    info("FIX") = InitEnrichArray()
                    info("ARC") = InitEnrichArray()
                    D(k) = info
                End If

                Dim fix As Variant: fix = info("FIX")
                fix(0) = v(F_VG_START, i): fix(1) = v(F_VG_NBJ, i)
                fix(2) = v(F_AM_START, i): fix(3) = v(F_AM_NBJ, i)
                fix(4) = v(F_SL_START, i): fix(5) = v(F_SL_NBJ, i)
                info("FIX") = fix

                ' extras FLUX demandés
                Dim j As Long
                For j = 1 To extraFluxFields.Count
                    info("FLUX:" & CStr(extraFluxFields(j))) = v(baseExtra + (j - 1), i)
                Next j
            Next i
        End If
    End If

    ' ===== 2) ARCHIVE (fins = endDate) =====
    If useArchive And IsDate(endDate) Then
        Dim dStr As String: dStr = Format(CDate(endDate), "mm/dd/yyyy")
        Dim selectExtrasA As String: selectExtrasA = BuildFieldList(extraArcFields)

        ' Une seule requête : on ramène Start/Duree/End des 3 natures + extras
        sql = "SELECT Booking, [NO DOSSIER CREDIT]," & _
              " VG_StartDate, VG_Duree, VG_EndDate," & _
              " AM_StartDate, AM_Duree, AM_EndDate," & _
              " SL_StartDate, SL_Duree, SL_EndDate" & selectExtrasA & _
              " FROM " & T_ARC & _
              " WHERE (FlagVG='YES' AND VG_EndDate=#" & dStr & "#)" & _
              "    OR (FlagAM='YES' AND AM_EndDate=#" & dStr & "#)" & _
              "    OR (FlagSL='YES' AND SL_EndDate=#" & dStr & "#)"

        cnt = "SELECT COUNT(*) FROM " & T_ARC & _
              " WHERE (FlagVG='YES' AND VG_EndDate=#" & dStr & "#)" & _
              "    OR (FlagAM='YES' AND AM_EndDate=#" & dStr & "#)" & _
              "    OR (FlagSL='YES' AND SL_EndDate=#" & dStr & "#)"

        v = RSGetRowsFast(cn, sql, cnt)
        If ArrayHasRows2D(v) Then
            Const A_BK = 0, A_NDC = 1
            Const A_VG_S = 2, A_VG_D = 3, A_VG_E = 4
            Const A_AM_S = 5, A_AM_D = 6, A_AM_E = 7
            Const A_SL_S = 8, A_SL_D = 9, A_SL_E = 10
            Dim baseExtraA As Long: baseExtraA = 11
            For i = 0 To UBound(v, 2)
                Dim k2 As String: k2 = MakeKey(v(A_BK, i), v(A_NDC, i))
                Dim info2 As Object
                If D.Exists(k2) Then
                    Set info2 = D(k2)
                Else
                    Set info2 = CreateObject("Scripting.Dictionary")
                    info2.CompareMode = 1
                    info2("FIX") = InitEnrichArray()
                    info2("ARC") = InitEnrichArray()
                    D(k2) = info2
                End If

                Dim arc As Variant: arc = info2("ARC")
                arc(0) = v(A_VG_S, i): arc(1) = v(A_VG_D, i): arc(6) = v(A_VG_E, i)
                arc(2) = v(A_AM_S, i): arc(3) = v(A_AM_D, i): arc(7) = v(A_AM_E, i)
                arc(4) = v(A_SL_S, i): arc(5) = v(A_SL_D, i): arc(8) = v(A_SL_E, i)
                info2("ARC") = arc

                ' extras ARC demandés
                Dim j2 As Long
                For j2 = 1 To extraArcFields.Count
                    info2("ARC:" & CStr(extraArcFields(j2))) = v(baseExtraA + (j2 - 1), i)
                Next j2
            Next i
        End If
    End If

    cn.Close: Set cn = Nothing
    Set LoadEnrichmentSnapshot = D
End Function


' --- Construit ", [Field1], [Field2], ..." à partir d'une Collection
Private Function BuildFieldList(ByVal fields As Collection) As String
    Dim s As String, j As Long
    For j = 1 To fields.Count
        s = s & ", " & fields(j)
        ' NB: garder les crochets dans le nom si déjà fournis par l'appelant
    Next j
    BuildFieldList = s
End Function

' --- Exécute SQL et renvoie GetRows(nb) avec COUNT(*) facultatif (sinon GetRows()) ---
Private Function RSGetRowsFast(ByVal cn As Object, ByVal sql As String, Optional ByVal countSql As String = "") As Variant
    Dim rows As Long
    If Len(countSql) > 0 Then
        Dim rsc As Object: Set rsc = cn.Execute(countSql)
        On Error Resume Next
        rows = CLng(rsc.Fields(0).Value)
        rsc.Close: Set rsc = Nothing
        On Error GoTo 0
    End If
    Dim rs As Object: Set rs = cn.Execute(sql)
    If rows > 0 Then
        RSGetRowsFast = rs.GetRows(rows)
    Else
        RSGetRowsFast = rs.GetRows()
    End If
    rs.Close: Set rs = Nothing
End Function

' --- Helpers génériques ---
Private Function ArrayHasRows2D(ByVal v As Variant) As Boolean
    On Error GoTo nope
    If IsArray(v) Then If UBound(v, 2) >= 0 Then ArrayHasRows2D = True
    Exit Function
nope:
    ArrayHasRows2D = False
End Function

Private Function MakeKey(ByVal booking As Variant, ByVal ndc As Variant) As String
    MakeKey = Trim$(UCase$(CStr(booking & ""))) & "||" & Trim$(CStr(ndc & ""))
End Function

' 9 slots : VG_Start, VG_NBJ, AM_Start, AM_NBJ, SL_Start, SL_NBJ, VG_End, AM_End, SL_End
Private Function InitEnrichArray() As Variant
    Dim a As Variant: a = Array(Empty, Empty, Empty, Empty, Empty, Empty, Empty, Empty, Empty)
    InitEnrichArray = a
End Function

Private Function NzDbl(ByVal v As Variant) As Double
    If IsError(v) Or IsNull(v) Then Exit Function
    If VarType(v) = vbString Then If Trim$(v) = "" Then Exit Function
    On Error Resume Next: NzDbl = CDbl(v): On Error GoTo 0
End Function

