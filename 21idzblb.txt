Sub GetBloombergDataByISIN()
    ' Déclaration des objets Bloomberg
    Dim session As Object
    Dim request As Object
    Dim service As Object
    Dim response As Object
    Dim isin As String
    Dim field As String
    Dim data As Variant
    
    ' Initialisation des variables
    isin = "US4592001014"  ' Exemple de code ISIN (IBM)
    field = "PX_LAST"  ' Champ à récupérer (prix de clôture)

    ' Création d'une session Bloomberg
    Set session = CreateObject("blpapicomLib.BlpSession")

    ' Démarrage de la session
    If session.Start() Then
        ' Ouverture du service Bloomberg
        If session.OpenService("//blp/refdata") Then
            Set service = session.GetService("//blp/refdata")
            Set request = service.CreateRequest("ReferenceDataRequest")
            
            ' Ajout de la sécurité et du champ à la requête
            request.GetElement("securities").AppendValue isin
            request.GetElement("fields").AppendValue field
            
            ' Envoi de la requête et réception de la réponse
            session.SendRequest request, Nothing
            Do While True
                Set response = session.NextEvent()
                If response.Type = 3 Then ' EventType.RESPONSE
                    Exit Do
                End If
            Loop

            ' Traitement de la réponse
            If Not response Is Nothing Then
                Dim securities As Object
                Dim securityData As Object
                Dim fieldData As Object
                
                Set securities = response.GetElement("securityData")
                Set securityData = securities.GetValue(0)
                Set fieldData = securityData.GetElement("fieldData")
                
                data = fieldData.GetElement(field).Value
                
                ' Affichage des données dans la feuille Excel
                Range("A1").Value = "ISIN"
                Range("B1").Value = "Field"
                Range("C1").Value = "Value"
                
                Range("A2").Value = isin
                Range("B2").Value = field
                Range("C2").Value = data
            End If
        End If
        ' Arrêt de la session
        session.Stop()
    End If
End Sub

Sub GetBloombergDataByISIN()
    ' Déclaration des objets Bloomberg
    Dim session As Object
    Dim request As Object
    Dim service As Object
    Dim response As Object
    Dim isin As String
    Dim fields As Variant
    Dim field As Variant
    Dim data As Variant
    Dim i As Integer
    
    ' Initialisation des variables
    isin = "US4592001014"  ' Exemple de code ISIN (IBM)
    fields = Array("PX_LAST", "PX_OPEN", "PX_HIGH", "PX_LOW")  ' Champs à récupérer

    ' Création d'une session Bloomberg
    Set session = CreateObject("blpapicomLib.BlpSession")

    ' Démarrage de la session
    If session.Start() Then
        ' Ouverture du service Bloomberg
        If session.OpenService("//blp/refdata") Then
            Set service = session.GetService("//blp/refdata")
            Set request = service.CreateRequest("ReferenceDataRequest")
            
            ' Ajout de la sécurité et des champs à la requête
            request.GetElement("securities").AppendValue isin
            For Each field In fields
                request.GetElement("fields").AppendValue field
            Next field
            
            ' Envoi de la requête et réception de la réponse
            session.SendRequest request, Nothing
            Do While True
                Set response = session.NextEvent()
                If response.Type = 3 Then ' EventType.RESPONSE
                    Exit Do
                End If
            Loop

            ' Traitement de la réponse
            If Not response Is Nothing Then
                Dim securities As Object
                Dim securityData As Object
                Dim fieldData As Object
                
                Set securities = response.GetElement("securityData")
                Set securityData = securities.GetValue(0)
                Set fieldData = securityData.GetElement("fieldData")
                
                ' Affichage des en-têtes dans la feuille Excel
                Range("A1").Value = "ISIN"
                Range("B1").Value = "Field"
                Range("C1").Value = "Value"
                
                ' Affichage des données dans la feuille Excel
                Range("A2").Value = isin
                i = 2
                For Each field In fields
                    Range("B" & i).Value = field
                    Range("C" & i).Value = fieldData.GetElement(field).Value
                    i = i + 1
                Next field
            End If
        End If
        ' Arrêt de la session
        session.Stop()
    End If
End Sub


Sub GetBloombergDataByISINs()
    ' Déclaration des objets Bloomberg
    Dim session As Object
    Dim request As Object
    Dim service As Object
    Dim response As Object
    Dim isins As Variant
    Dim fields As Variant
    Dim isin As Variant
    Dim field As Variant
    Dim data As Variant
    Dim i As Integer
    Dim j As Integer
    Dim row As Integer
    Dim col As Integer
    
    ' Initialisation des variables
    isins = Array("US4592001014", "US5949181045")  ' Liste des codes ISIN
    fields = Array("PX_LAST", "PX_OPEN", "PX_HIGH", "PX_LOW")  ' Liste des champs à récupérer

    ' Création d'une session Bloomberg
    Set session = CreateObject("blpapicomLib.BlpSession")

    ' Démarrage de la session
    If session.Start() Then
        ' Ouverture du service Bloomberg
        If session.OpenService("//blp/refdata") Then
            Set service = session.GetService("//blp/refdata")
            Set request = service.CreateRequest("ReferenceDataRequest")
            
            ' Ajout des ISINs et des champs à la requête
            For Each isin In isins
                request.GetElement("securities").AppendValue isin
            Next isin
            For Each field In fields
                request.GetElement("fields").AppendValue field
            Next field
            
            ' Envoi de la requête et réception de la réponse
            session.SendRequest request, Nothing
            Do While True
                Set response = session.NextEvent()
                If response.Type = 3 Then ' EventType.RESPONSE
                    Exit Do
                End If
            Loop

            ' Initialisation des en-têtes dans la feuille Excel
            Range("A1").Value = "ISIN"
            For j = LBound(fields) To UBound(fields)
                Range(Cells(1, j + 2), Cells(1, j + 2)).Value = fields(j)
            Next j
            
            ' Traitement de la réponse
            If Not response Is Nothing Then
                Dim securities As Object
                Dim securityData As Object
                Dim fieldData As Object
                
                Set securities = response.GetElement("securityData")
                
                row = 2 ' Initialisation de la ligne pour l'affichage des données
                For Each securityData In securities.Values
                    isin = securityData.GetElementAsString("security")
                    Set fieldData = securityData.GetElement("fieldData")
                    
                    ' Affichage de l'ISIN
                    Range("A" & row).Value = isin
                    
                    col = 2 ' Initialisation de la colonne pour les champs
                    For Each field In fields
                        On Error Resume Next ' Gestion des erreurs pour les champs manquants
                        Range(Cells(row, col), Cells(row, col)).Value = fieldData.GetElement(field).Value
                        On Error GoTo 0
                        col = col + 1
                    Next field
                    row = row + 1
                Next securityData
            End If
        End If
        ' Arrêt de la session
        session.Stop()
    End If
End Sub

Sub GetBloombergDataByISINs()
    ' Déclaration des objets Bloomberg
    Dim session As Object
    Dim request As Object
    Dim service As Object
    Dim response As Object
    Dim isins As Variant
    Dim fields As Variant
    Dim isin As Variant
    Dim field As Variant
    Dim data As Variant
    Dim i As Integer
    Dim j As Integer
    Dim row As Integer
    Dim col As Integer
    Dim results() As Variant
    
    ' Initialisation des variables
    isins = Array("US4592001014", "US5949181045")  ' Liste des codes ISIN
    fields = Array("PX_LAST", "PX_OPEN", "PX_HIGH", "PX_LOW")  ' Liste des champs à récupérer
    
    ' Dimensionnement du tableau pour stocker les résultats
    ReDim results(1 To UBound(isins) + 1, 1 To UBound(fields) + 2)
    
    ' Ajout des en-têtes au tableau
    results(1, 1) = "ISIN"
    For j = LBound(fields) To UBound(fields)
        results(1, j + 2) = fields(j)
    Next j
    
    ' Création d'une session Bloomberg
    Set session = CreateObject("blpapicomLib.BlpSession")
    
    ' Démarrage de la session
    If session.Start() Then
        ' Ouverture du service Bloomberg
        If session.OpenService("//blp/refdata") Then
            Set service = session.GetService("//blp/refdata")
            Set request = service.CreateRequest("ReferenceDataRequest")
            
            ' Ajout des ISINs et des champs à la requête
            For Each isin In isins
                request.GetElement("securities").AppendValue isin
            Next isin
            For Each field In fields
                request.GetElement("fields").AppendValue field
            Next field
            
            ' Envoi de la requête et réception de la réponse
            session.SendRequest request, Nothing
            Do While True
                Set response = session.NextEvent()
                If response.Type = 3 Then ' EventType.RESPONSE
                    Exit Do
                End If
            Loop
            
            ' Traitement de la réponse et remplissage du tableau
            If Not response Is Nothing Then
                Dim securities As Object
                Dim securityData As Object
                Dim fieldData As Object
                
                Set securities = response.GetElement("securityData")
                
                row = 2 ' Initialisation de la ligne pour l'affichage des données
                For Each securityData In securities.Values
                    isin = securityData.GetElementAsString("security")
                    Set fieldData = securityData.GetElement("fieldData")
                    
                    ' Stockage de l'ISIN
                    results(row, 1) = isin
                    
                    col = 2 ' Initialisation de la colonne pour les champs
                    For Each field In fields
                        On Error Resume Next ' Gestion des erreurs pour les champs manquants
                        results(row, col) = fieldData.GetElement(field).Value
                        On Error GoTo 0
                        col = col + 1
                    Next field
                    row = row + 1
                Next securityData
            End If
        End If
        ' Arrêt de la session
        session.Stop()
    End If
    
    ' Écriture du tableau dans la feuille Excel en une seule opération
    Dim outputRange As Range
    Set outputRange = Range("A1").Resize(UBound(results, 1), UBound(results, 2))
    outputRange.Value = results
End Sub

