' ===========================================================
' Enrichissement feuille — version ULTRA SIMPLE & RAPIDE
'   - 1 seule requête Access (JOIN sur les clés de T_Today)
'   - 0 boucle Do...EOF (GetRows + COUNT)
'   - 1 seule boucle sur la feuille
'   - switch de vue: "BOTH" (défaut) / "FLUX" / "ARCHIVE"
'
' Sorties (identiques à l’existant) :
'   NB Jours retard VG/AM/SL
'   Date début VG/AM/SL
'   Date fin   VG/AM/SL
'   Dépassement non autorisé
' ===========================================================
Public Sub EnrichSheetFromFlux_3in1( _
        ByVal dbPath As String, _
        ByVal ws As Worksheet, _
        Optional ByVal modeView As String = "BOTH" _
    )

    ' --- Map colonnes source (feuille) ---
    Dim map As Object: Set map = CreateObject("Scripting.Dictionary")
    MapCol map, ws, COL_BOOKING
    MapCol map, ws, COL_DOSSIER
    MapCol map, ws, COL_CONSO
    MapCol map, ws, COL_LIMITE

    ' --- Bornes ---
    Dim lastRow As Long: lastRow = ws.Cells(ws.Rows.Count, map(COL_BOOKING)).End(xlUp).Row
    If lastRow < 2 Then Exit Sub
    Dim n As Long: n = lastRow - 1

    ' --- Colonnes de sortie (assure) ---
    Dim cNBJ_VG As Long, cDEB_VG As Long, cFIN_VG As Long
    Dim cNBJ_AM As Long, cDEB_AM As Long, cFIN_AM As Long
    Dim cNBJ_SL As Long, cDEB_SL As Long, cFIN_SL As Long
    Dim cNA As Long
    cNBJ_VG = EnsureColumn(ws, COL_NBJ_VG): cDEB_VG = EnsureColumn(ws, COL_DEB_VG): cFIN_VG = EnsureColumn(ws, COL_FIN_VG)
    cNBJ_AM = EnsureColumn(ws, COL_NBJ_AM): cDEB_AM = EnsureColumn(ws, COL_DEB_AM): cFIN_AM = EnsureColumn(ws, COL_FIN_AM)
    cNBJ_SL = EnsureColumn(ws, COL_NBJ_SL): cDEB_SL = EnsureColumn(ws, COL_DEB_SL): cFIN_SL = EnsureColumn(ws, COL_FIN_SL)
    cNA = EnsureColumn(ws, COL_FLAG_NA)

    ' --- Lecture des colonnes nécessaires (NA local) ---
    Dim arrBk As Variant, arrNdc As Variant, arrConso As Variant, arrLim As Variant
    arrBk = ws.Range(ws.Cells(2, map(COL_BOOKING)), ws.Cells(lastRow, map(COL_BOOKING))).Value2
    arrNdc = ws.Range(ws.Cells(2, map(COL_DOSSIER)), ws.Cells(lastRow, map(COL_DOSSIER))).Value2
    arrConso = ws.Range(ws.Cells(2, map(COL_CONSO)), ws.Cells(lastRow, map(COL_CONSO))).Value2
    arrLim = ws.Range(ws.Cells(2, map(COL_LIMITE)), ws.Cells(lastRow, map(COL_LIMITE))).Value2

    ' --- Date de prod de la feuille (pour filtrer l’archive du jour) ---
    Dim d As Variant: d = DetectSheetProductionDate(ws)
    Dim haveDate As Boolean: haveDate = IsDate(d)
    Dim dStr As String: If haveDate Then dStr = Format(CDate(d), "mm/dd/yyyy")

    ' --- Requête unique : clés de feuille (T_Today) + Flux + Archive(J) ---
    Dim cn As Object: Set cn = GetConn(dbPath)

    Dim sqlArc As String
    If haveDate Then
        sqlArc = _
          "SELECT Booking, [NO DOSSIER CREDIT], " & _
          "  VG_StartDate AS VG_Deb_Arc, VG_Duree AS VG_Dur_Arc, VG_EndDate AS VG_End_Arc, " & _
          "  AM_StartDate AS AM_Deb_Arc, AM_Duree AS AM_Dur_Arc, AM_EndDate AS AM_End_Arc, " & _
          "  SL_StartDate AS SL_Deb_Arc, SL_Duree AS SL_Dur_Arc, SL_EndDate AS SL_End_Arc " & _
          "FROM " & T_ARC & " " & _
          "WHERE (FlagVG='YES' AND VG_EndDate=#" & dStr & "#) " & _
          "   OR (FlagAM='YES' AND AM_EndDate=#" & dStr & "#) " & _
          "   OR (FlagSL='YES' AND SL_EndDate=#" & dStr & "#)"
    Else
        ' pas de date détectée => sous-requête vide pour garder le LEFT JOIN simple
        sqlArc = "SELECT Booking, [NO DOSSIER CREDIT], NULL AS VG_Deb_Arc, NULL AS VG_Dur_Arc, NULL AS VG_End_Arc, " & _
                 "NULL AS AM_Deb_Arc, NULL AS AM_Dur_Arc, NULL AS AM_End_Arc, " & _
                 "NULL AS SL_Deb_Arc, NULL AS SL_Dur_Arc, NULL AS SL_End_Arc " & _
                 "FROM " & T_ARC & " WHERE 1=0"
    End If

    Dim sql As String
    sql = _
      "SELECT k.Booking, k.[NO DOSSIER CREDIT], " & _
      "       f.VG_StartDate  AS VG_Deb_Flux,  f.VG_NbJoursRetard AS VG_Nbj_Flux, " & _
      "       f.AM_StartDate  AS AM_Deb_Flux,  f.AM_NbJoursRetard AS AM_Nbj_Flux, " & _
      "       f.SL_StartDate  AS SL_Deb_Flux,  f.SL_NbJoursRetard AS SL_Nbj_Flux, " & _
      "       a.VG_Deb_Arc, a.VG_Dur_Arc, a.VG_End_Arc, " & _
      "       a.AM_Deb_Arc, a.AM_Dur_Arc, a.AM_End_Arc, " & _
      "       a.SL_Deb_Arc, a.SL_Dur_Arc, a.SL_End_Arc " & _
      "FROM (SELECT DISTINCT Booking, [NO DOSSIER CREDIT] FROM " & T_TODAY & ") AS k " & _
      "LEFT JOIN " & T_FLUX & " AS f ON k.Booking=f.Booking AND k.[NO DOSSIER CREDIT]=f.[NO DOSSIER CREDIT] " & _
      "LEFT JOIN (" & sqlArc & ") AS a ON k.Booking=a.Booking AND k.[NO DOSSIER CREDIT]=a.[NO DOSSIER CREDIT]"

    Dim cnt As String
    cnt = "SELECT COUNT(*) FROM (SELECT DISTINCT Booking, [NO DOSSIER CREDIT] FROM " & T_TODAY & ")"

    Dim v As Variant
    v = RSGetRowsFast(cn, sql, cnt)          ' => 2D (fields x rows)
    cn.Close: Set cn = Nothing

    ' --- Indexer les lignes par clé (k -> index colonne du tableau v) ---
    Dim idx As Object: Set idx = CreateObject("Scripting.Dictionary")
    idx.CompareMode = 1 ' TextCompare

    If ArrayHasRows2D(v) Then
        Dim r As Long
        For r = 0 To UBound(v, 2)
            idx(MakeKey(v(0, r), v(1, r))) = r
        Next r
    End If

    ' --- Buffers sortie ---
    Dim oNBJ_VG() As Variant, oDEB_VG() As Variant, oFIN_VG() As Variant
    Dim oNBJ_AM() As Variant, oDEB_AM() As Variant, oFIN_AM() As Variant
    Dim oNBJ_SL() As Variant, oDEB_SL() As Variant, oFIN_SL() As Variant
    Dim oNA() As Variant

    ReDim oNBJ_VG(1 To n, 1 To 1): ReDim oDEB_VG(1 To n, 1 To 1): ReDim oFIN_VG(1 To n, 1 To 1)
    ReDim oNBJ_AM(1 To n, 1 To 1): ReDim oDEB_AM(1 To n, 1 To 1): ReDim oFIN_AM(1 To n, 1 To 1)
    ReDim oNBJ_SL(1 To n, 1 To 1): ReDim oDEB_SL(1 To n, 1 To 1): ReDim oFIN_SL(1 To n, 1 To 1)
    ReDim oNA(1 To n, 1 To 1)

    ' --- Boucle unique sur la feuille ---
    Dim i As Long, k As String, j As Long
    Dim rowIdx As Long
    Dim mode As String: mode = UCase$(Trim$(modeView))

    For i = 1 To n
        k = MakeKey(arrBk(i, 1), arrNdc(i, 1))

        ' NA local = Abs(Conso) > Limite
        If Abs(NzDbl(arrConso(i, 1))) > NzDbl(arrLim(i, 1)) Then
            oNA(i, 1) = "YES"
        Else
            oNA(i, 1) = "NO"
        End If

        If idx.Exists(k) Then
            rowIdx = idx(k)
            ' mapping colonnes du tableau v (voir SELECT ci-dessus)
            Const F_VG_Deb_F = 2, F_VG_Nbj_F = 3, F_AM_Deb_F = 4, F_AM_Nbj_F = 5, F_SL_Deb_F = 6, F_SL_Nbj_F = 7
            Const F_VG_Deb_A = 8, F_VG_Dur_A = 9, F_VG_End_A = 10
            Const F_AM_Deb_A = 11, F_AM_Dur_A = 12, F_AM_End_A = 13
            Const F_SL_Deb_A = 14, F_SL_Dur_A = 15, F_SL_End_A = 16

            Select Case mode
                Case "FLUX"
                    ' Déb/nbj = Flux ; Fin = vide
                    oDEB_VG(i, 1) = v(F_VG_Deb_F, rowIdx): oNBJ_VG(i, 1) = v(F_VG_Nbj_F, rowIdx): oFIN_VG(i, 1) = Empty
                    oDEB_AM(i, 1) = v(F_AM_Deb_F, rowIdx): oNBJ_AM(i, 1) = v(F_AM_Nbj_F, rowIdx): oFIN_AM(i, 1) = Empty
                    oDEB_SL(i, 1) = v(F_SL_Deb_F, rowIdx): oNBJ_SL(i, 1) = v(F_SL_Nbj_F, rowIdx): oFIN_SL(i, 1) = Empty

                Case "ARCHIVE"
                    ' Déb/nbj/fin = Archive (du jour)
                    oDEB_VG(i, 1) = v(F_VG_Deb_A, rowIdx): oNBJ_VG(i, 1) = v(F_VG_Dur_A, rowIdx): oFIN_VG(i, 1) = v(F_VG_End_A, rowIdx)
                    oDEB_AM(i, 1) = v(F_AM_Deb_A, rowIdx): oNBJ_AM(i, 1) = v(F_AM_Dur_A, rowIdx): oFIN_AM(i, 1) = v(F_AM_End_A, rowIdx)
                    oDEB_SL(i, 1) = v(F_SL_Deb_A, rowIdx): oNBJ_SL(i, 1) = v(F_SL_Dur_A, rowIdx): oFIN_SL(i, 1) = v(F_SL_End_A, rowIdx)

                Case Else ' BOTH (défaut)
                    ' Déb/nbj = Flux si dispo, sinon Archive ; Fin = Archive
                    oDEB_VG(i, 1) = FirstNotEmpty(v(F_VG_Deb_F, rowIdx), v(F_VG_Deb_A, rowIdx))
                    oNBJ_VG(i, 1) = FirstNotEmpty(v(F_VG_Nbj_F, rowIdx), v(F_VG_Dur_A, rowIdx))
                    oFIN_VG(i, 1) = v(F_VG_End_A, rowIdx)

                    oDEB_AM(i, 1) = FirstNotEmpty(v(F_AM_Deb_F, rowIdx), v(F_AM_Deb_A, rowIdx))
                    oNBJ_AM(i, 1) = FirstNotEmpty(v(F_AM_Nbj_F, rowIdx), v(F_AM_Dur_A, rowIdx))
                    oFIN_AM(i, 1) = v(F_AM_End_A, rowIdx)

                    oDEB_SL(i, 1) = FirstNotEmpty(v(F_SL_Deb_F, rowIdx), v(F_SL_Deb_A, rowIdx))
                    oNBJ_SL(i, 1) = FirstNotEmpty(v(F_SL_Nbj_F, rowIdx), v(F_SL_Dur_A, rowIdx))
                    oFIN_SL(i, 1) = v(F_SL_End_A, rowIdx)
            End Select
        End If
    Next i

    ' --- Ecritures en bloc ---
    ws.Cells(2, cNBJ_VG).Resize(n, 1).Value2 = oNBJ_VG
    ws.Cells(2, cDEB_VG).Resize(n, 1).Value2 = oDEB_VG
    ws.Cells(2, cFIN_VG).Resize(n, 1).Value2 = oFIN_VG

    ws.Cells(2, cNBJ_AM).Resize(n, 1).Value2 = oNBJ_AM
    ws.Cells(2, cDEB_AM).Resize(n, 1).Value2 = oDEB_AM
    ws.Cells(2, cFIN_AM).Resize(n, 1).Value2 = oFIN_AM

    ws.Cells(2, cNBJ_SL).Resize(n, 1).Value2 = oNBJ_SL
    ws.Cells(2, cDEB_SL).Resize(n, 1).Value2 = oDEB_SL
    ws.Cells(2, cFIN_SL).Resize(n, 1).Value2 = oFIN_SL

    ws.Cells(2, cNA).Resize(n, 1).Value2 = oNA

    ' --- Formats ---
    ws.Columns(cNBJ_VG).NumberFormat = "0"
    ws.Columns(cNBJ_AM).NumberFormat = "0"
    ws.Columns(cNBJ_SL).NumberFormat = "0"

    ws.Columns(cDEB_VG).NumberFormat = "dd/mm/yyyy"
    ws.Columns(cDEB_AM).NumberFormat = "dd/mm/yyyy"
    ws.Columns(cDEB_SL).NumberFormat = "dd/mm/yyyy"

    ws.Columns(cFIN_VG).NumberFormat = "dd/mm/yyyy"
    ws.Columns(cFIN_AM).NumberFormat = "dd/mm/yyyy"
    ws.Columns(cFIN_SL).NumberFormat = "dd/mm/yyyy"
End Sub

' --------- Helpers locaux ---------
Private Function FirstNotEmpty(ByVal v1 As Variant, ByVal v2 As Variant) As Variant
    If IsEmpty(v1) Or IsNull(v1) Then
        FirstNotEmpty = v2
    ElseIf VarType(v1) = vbString And Trim$(v1) = "" Then
        FirstNotEmpty = v2
    Else
        FirstNotEmpty = v1
    End If
End Function
