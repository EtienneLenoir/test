Génial — voilà une archi Access taillée pour ta règle métier (jour de retard ⇢ Insuffisance < 0), en une seule base, rapide et propre.

Architecture générale

1 base Access unique (pas de split obligatoire).

3 tables seulement :

stg_Excel : staging du fichier du jour (écrasée à chaque import).

ret_FluxCurrent : flux courant — 1 ligne par retard en cours (par clé).

ret_Archive : historique clos — 1 ligne par période de retard terminée.

Clé métier partout : (Booking, NO DOSSIER CREDIT)

Règle : un enregistrement du jour avec Insuffisance < 0 = jour de retard.

Tables & champs
1) stg_Excel (sas d’import — aucune contrainte)

Booking (Texte 10)

Production Date (Date/Heure)

NO DOSSIER CREDIT (Texte 50)

NO NTERVENANT (Texte 50)

NO NTERVENANT GRP (Texte 50)

Ligne (Texte 50)

Limite (Double)

Consommation (Double)

Montant Surete (Double)

Montant AM (Double)

Insuffisance (Double)

Taux de couverture (Double)

Usage : juste pour lire le jour J. On vide puis on réimporte.

2) ret_FluxCurrent (retards en cours — une ligne par clé)

But : stocker la période ouverte et ses KPI, mise à jour daily.

Booking (Texte 10) — PK partielle

NO DOSSIER CREDIT (Texte 50) — PK partielle
➡️ PK composite : (Booking, [NO DOSSIER CREDIT])

DateBegin (Date/Heure) — 1er jour où Insuffisance < 0

LastProdDate (Date/Heure) — dernière Production Date traitée

NbDays (Entier long) — compteur de jours de retard (incrémente chaque jour où Insuffisance < 0)

MinInsuffisance (Double) — le plus négatif observé pendant la période

MinInsuffDate (Date/Heure) — date du min insuffisance

LastInsuffisance (Double) — valeur du jour pour info/contrôle

CommentaireRisque (Mémo), CommentaireFront (Mémo) — optionnels

Index conseillés

PK (Booking, NO DOSSIER CREDIT)

IX_Flux_LastProdDate sur LastProdDate (contrôle/tri)

3) ret_Archive (retards clos — une ligne par période)

But : historiser les périodes une fois terminées (pour stats).

PeriodID (AutoNumber) — PK

Booking (Texte 10)

NO DOSSIER CREDIT (Texte 50)

DateBegin (Date/Heure)

DateEnd (Date/Heure) — dernier jour en retard (J−1 à la clôture)

NbDays (Entier long)

MinInsuffisance (Double)

MinInsuffDate (Date/Heure)

Index conseillés

IX_Arch_Key sur (Booking, NO DOSSIER CREDIT)

IX_Arch_DateEnd sur DateEnd

(Optionnel) Unique logique (Booking, NO DOSSIER CREDIT, DateBegin) si tu veux éviter toute doublure d’archive accidentelle.

Clés & intégrité

Pas de FK obligatoires (on a choisi minimal & rapide).

Toute l’unicité opérationnelle repose sur la PK composite de ret_FluxCurrent.

ret_Archive est append-only (on n’y ré-ouvre jamais une période).

Mécanisme “vitesse de croisière” (bouton daily)

Chaque jour, tu appuies sur un bouton qui exécute le pipeline :

Importer le fichier du jour → stg_Excel (remplacer/vider puis TransferSpreadsheet).

Ouvrir / prolonger les retards du jour (Insuffisance < 0) :

si la clé n’existe pas dans ret_FluxCurrent → INSERT :
DateBegin = Production Date, NbDays=1, MinInsuff = Insuffisance, MinInsuffDate = Production Date.

si la clé existe → UPDATE :
NbDays += 1, LastProdDate = Production Date, LastInsuffisance = Insuffisance,
mettre à jour le min : si Insuffisance < MinInsuffisance alors maj MinInsuffisance & MinInsuffDate.

Clore & archiver les retards absents du jour (pas Insuffisance < 0) :

INSERT dans ret_Archive : DateEnd = (Production Date du jour) − 1, NbDays tel que stocké.

DELETE la ligne correspondante de ret_FluxCurrent.

Annoter ta feuille du jour (même fichier) : ajouter 2 colonnes

NB Jours de retard (pris de ret_FluxCurrent.NbDays)

Date début retard (pris de ret_FluxCurrent.DateBegin)

(Optionnel) exporter un report Excel (Daily + Stats).

Tout est transactionnel DAO pour la vitesse (BEGIN/COMMIT), et stg_Excel reste légère.

Règles métier explicites

Jour de retard = existe une ligne du jour avec Insuffisance < 0.

Ouverture : premier jour où la clé passe sous 0.

Prolongation : tant que la clé est sous 0, NbDays s’incrémente.

Clôture : premier jour où pas Insuffisance < 0 → on archive (DateEnd = J−1) et on retire du flux.

Gravité : MinInsuffisance (le plus négatif observé) + MinInsuffDate.

Statistiques possibles (simples et rapides)

Retards en cours : ret_FluxCurrent (stock, avec NbDays en direct).

Historique : ret_Archive (durées, tendances, par Booking / dossier).

Fenêtre glissante (ex. 30/90 j) : agrégations sur ret_Archive + ajout des retards en cours via DateDiff('d', DateBegin, Date())+1.

Exemples rapides :

Stock courant
SELECT Booking, [NO DOSSIER CREDIT], DateBegin, NbDays, MinInsuffisance FROM ret_FluxCurrent;

Périodes clôturées
SELECT Booking, [NO DOSSIER CREDIT], DateBegin, DateEnd, NbDays FROM ret_Archive;

Par Booking (30j)
SELECT Booking, SUM(NbDays) FROM ret_Archive WHERE DateEnd>=DateAdd('d',-30,Date()) GROUP BY Booking;

Pourquoi c’est rapide & maintenable

Aucune table volumineuse “par jour” : on ne stocke pas tout l’historique quotidien, seulement les périodes.

Index ciblés : PK composite en flux, index datés en archive → scans courts.

Code court & clair : INSERT/UPDATE/DELETE déterministes, sans jointures coûteuses.

Staging isolé : zéro contrainte, on peut accepter des fichiers imparfaits puis appliquer la règle métier.

Bonus (petits plus utiles)

LastInsuffisance en flux pour vérifier la tendance du jour.

CommentaireRisque / CommentaireFront pour consigner la prise en charge (optionnel).

Contrôle qualité simple :

rejeter les lignes du jour sans Booking ou sans NO DOSSIER CREDIT,

normaliser Booking en UPPER TRIM,

forcer Insuffisance en Double (Nz=0 si vide).

DDL synthétique (si tu veux créer vite)

ret_FluxCurrent : PK (Booking, NO DOSSIER CREDIT)

ret_Archive : PK PeriodID, Index (Booking, NO DOSSIER CREDIT) + DateEnd

stg_Excel : aucun index requis.

(Tu as déjà tout le code VBA d’import, de mise à jour Flux/Archive et d’annotation Excel dans mes messages précédents — il colle exactement à cette structure.)

Routine quotidienne = un bouton

Sélection du fichier Excel du jour.

Importer → Mettre à jour Flux/Archive → Annoter la feuille (NB jours & Date début).

(Optionnel) Exporter un classeur de reporting.

Si tu veux, je te fournis un unique module CreateSchema_Retards() + un module Bouton_Daily() prêts à coller (ils correspondent exactement à cette archi).