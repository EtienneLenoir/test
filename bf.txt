' ================== CONFIG TABLE (Key-Value) ==================
Private Const T_CFG As String = "T_Config"

' Crée T_Config si absent (clé primaire propre + repli par index si besoin)
Private Sub EnsureConfigTable(ByVal cn As Object)
    On Error GoTo Fallback
    ExecIfNotExists cn, T_CFG, _
        "CREATE TABLE " & T_CFG & " (" & _
        "  CfgKey TEXT(50) NOT NULL," & _
        "  CfgVal TEXT(255)," & _
        "  CONSTRAINT PK_" & T_CFG & " PRIMARY KEY (CfgKey)" & _
        ")"
    Exit Sub
Fallback:
    On Error Resume Next
    ExecIfNotExists cn, T_CFG, _
        "CREATE TABLE " & T_CFG & " (" & _
        "  CfgKey TEXT(50) NOT NULL," & _
        "  CfgVal TEXT(255)" & _
        ")"
    ' clé primaire via index (syntaxe Access)
    cn.Execute "CREATE UNIQUE INDEX PK_" & T_CFG & " ON " & T_CFG & " (CfgKey) WITH PRIMARY;"
    On Error GoTo 0
End Sub

' Upsert "clé → valeur"
Private Sub CfgSet(ByVal cn As Object, ByVal k As String, ByVal v As String)
    Dim sK As String, sV As String, n As Long
    sK = Replace(k, "'", "''")
    sV = Replace(v, "'", "''")
    cn.Execute "UPDATE " & T_CFG & " SET CfgVal='" & sV & "' WHERE CfgKey='" & sK & "'", n
    If n = 0 Then
        cn.Execute "INSERT INTO " & T_CFG & " (CfgKey, CfgVal) VALUES ('" & sK & "','" & sV & "')"
    End If
End Sub

' Lecture avec valeur par défaut si absent
Private Function CfgGet(ByVal cn As Object, ByVal k As String, Optional ByVal defaultVal As String = "") As String
    Dim rs As Object, sK As String
    sK = Replace(k, "'", "''")
    Set rs = CreateObject("ADODB.Recordset")
    rs.Open "SELECT CfgVal FROM " & T_CFG & " WHERE CfgKey='" & sK & "'", cn, 1, 1
    If Not (rs.EOF Or rs.BOF) Then
        CfgGet = rs.Fields(0).Value & ""
    Else
        CfgGet = defaultVal
    End If
    rs.Close: Set rs = Nothing
End Function

' Suppression clé (facultatif)
Private Sub CfgDel(ByVal cn As Object, ByVal k As String)
    Dim sK As String
    sK = Replace(k, "'", "''")
    cn.Execute "DELETE FROM " & T_CFG & " WHERE CfgKey='" & sK & "'"
End Sub
