# üéØ Objectif (en une phrase)
Historiser **le nombre de jours de retard** li√©s aux **insuffisances (Insuffisance < 0)** par **cl√© unique = Booking + NO DOSSIER CREDIT**, avec un **flux courant** et une **archive**, le tout **mis √† jour chaque jour** depuis Excel par un bouton.

---

## üß± Architecture propre et maintenable

### 1) Fichier Access (unique)
`Lombard_Retards.accdb` ‚Äì 3 tables principales + 1 table de staging + 1 table de log

**a) T_FluxRetards** (retards **en cours**)
- `Booking` (TEXT, NOT NULL)
- `NO DOSSIER CREDIT` (TEXT, NOT NULL)
- `StartDate` (DATE, NOT NULL) ‚Üí date de d√©but du retard
- `LastUpdateDate` (DATE, NOT NULL)
- `NbJoursRetard` (LONG, NOT NULL)
- `WorstInsuffisance` (DOUBLE) ‚Üí *le plus n√©gatif observ√©*
- `DateWorstInsuffisance` (DATE)
- `LastInsuffisance` (DOUBLE)
- `LastTauxCouverture` (DOUBLE)
- Champs de contexte (facultatif mais recommand√© pour reporting) : `NO INTERVENANT`, `NO INTERVENANT GRP`, `Ligne`, `Limite` (DOUBLE), `Consommation` (DOUBLE), `Montant Surete` (DOUBLE), `Montant AM` (DOUBLE), `Production Date` (DATE)
- **PK compos√©e**: `(Booking, [NO DOSSIER CREDIT])`

**b) T_ArchiveRetards** (√©pisodes **cl√¥tur√©s**)
- m√™me cl√©s + m√©triques consolid√©es :
  - `StartDate`, `EndDate`, `Duree` (LONG)
  - `WorstInsuffisance`, `DateWorstInsuffisance`
  - copie des derniers contextes utiles (au moment de la cl√¥ture)
  - `ArchivedAt` (DATE, d√©faut = Date())

**c) T_Today** (staging du jour)
- structure miroir de la feuille Excel (champs d‚Äôentr√©e du jour)

**d) T_RunLog** (journal d‚Äôex√©cution)
- `RunAt` (DATETIME), `RowsImported`, `NewFlux`, `Continued`, `Closed`, `User`

**Index**
- Index/PK composite `(Booking, [NO DOSSIER CREDIT])` sur T_FluxRetards et T_ArchiveRetards
- Index sur `StartDate`, `EndDate` (reporting)

### 2) Feuille Excel (quotidienne)
- Colonnes d‚Äôentr√©e (exactement comme votre fichier)
- Deux colonnes ajout√©es automatiquement par le bouton VBA :
  - **`NB Jours de retard`**
  - **`Date d√©but retard`**

> Optionnel : on peut aussi pousser `WorstInsuffisance` et `DateWorstInsuffisance` sur la feuille si souhait√©.

---

## üîÅ R√®gles de gestion (jour J)
1. **Insuffisance < 0 = jour de retard.**
2. Si une cl√© **existe d√©j√†** en flux et **reste en retard**, on **incr√©mente `NbJoursRetard`** (+1), on met √† jour `LastInsuffisance`, `LastTauxCouverture`, et on **met √† jour le pire** si l‚Äôinsuffisance du jour est **plus n√©gative**.
3. Si une cl√© **nouvelle** est en retard et **n‚Äôest pas en flux**, on **cr√©e** une ligne dans `T_FluxRetards` avec `StartDate = Date()` et `NbJoursRetard = 1`.
4. Si une cl√© **en flux** n‚Äôest **plus** en retard (ou n‚Äôexiste plus dans le fichier du jour), on **archive** dans `T_ArchiveRetards` (`EndDate = Date()`, `Duree = NbJoursRetard`) puis on **supprime du flux**.
5. La feuille Excel du jour est enrichie : pour les lignes **Insuffisance < 0**, on remplit `NB Jours de retard` et `Date d√©but retard` depuis `T_FluxRetards`.

---

## üõ†Ô∏è SQL DDL (cr√©ation des tables Access)
√Ä ex√©cuter automatiquement par le VBA si la base n‚Äôexiste pas.

```sql
-- T_FluxRetards
CREATE TABLE T_FluxRetards (
  Booking TEXT(20) NOT NULL,
  [NO DOSSIER CREDIT] TEXT(50) NOT NULL,
  StartDate DATE NOT NULL,
  LastUpdateDate DATE NOT NULL,
  NbJoursRetard LONG NOT NULL,
  WorstInsuffisance DOUBLE,
  DateWorstInsuffisance DATE,
  LastInsuffisance DOUBLE,
  LastTauxCouverture DOUBLE,
  [NO INTERVENANT] TEXT(50),
  [NO INTERVENANT GRP] TEXT(50),
  Ligne TEXT(50),
  Limite DOUBLE,
  Consommation DOUBLE,
  [Montant Surete] DOUBLE,
  [Montant AM] DOUBLE,
  [Production Date] DATE,
  CONSTRAINT PK_Flux PRIMARY KEY (Booking, [NO DOSSIER CREDIT])
);
CREATE INDEX IX_Flux_Start ON T_FluxRetards (StartDate);

-- T_ArchiveRetards
CREATE TABLE T_ArchiveRetards (
  Booking TEXT(20) NOT NULL,
  [NO DOSSIER CREDIT] TEXT(50) NOT NULL,
  StartDate DATE NOT NULL,
  EndDate DATE NOT NULL,
  Duree LONG NOT NULL,
  WorstInsuffisance DOUBLE,
  DateWorstInsuffisance DATE,
  LastInsuffisance DOUBLE,
  LastUpdateDate DATE,
  [NO INTERVENANT] TEXT(50),
  [NO INTERVENANT GRP] TEXT(50),
  Ligne TEXT(50),
  Limite DOUBLE,
  Consommation DOUBLE,
  [Montant Surete] DOUBLE,
  [Montant AM] DOUBLE,
  [Production Date] DATE,
  ArchivedAt DATE DEFAULT Date(),
  CONSTRAINT IX_Arc_Key UNIQUE (Booking, [NO DOSSIER CREDIT], StartDate)
);
CREATE INDEX IX_Arc_End ON T_ArchiveRetards (EndDate);

-- T_Today (staging)
CREATE TABLE T_Today (
  Booking TEXT(20),
  [Production Date] DATE,
  [NO DOSSIER CREDIT] TEXT(50),
  [NO INTERVENANT] TEXT(50),
  [NO INTERVENANT GRP] TEXT(50),
  Ligne TEXT(50),
  Limite DOUBLE,
  Consommation DOUBLE,
  [Montant Surete] DOUBLE,
  [Montant AM] DOUBLE,
  Insuffisance DOUBLE,
  [Taux de couverture] DOUBLE
);
CREATE INDEX IX_Today_Key ON T_Today (Booking, [NO DOSSIER CREDIT]);

-- T_RunLog
CREATE TABLE T_RunLog (
  RunAt DATETIME NOT NULL,
  RowsImported LONG,
  NewFlux LONG,
  Continued LONG,
  Closed LONG,
  [User] TEXT(100)
);
```

---

## üîß VBA Excel ‚Äì bouton quotidien (tout-en-un)
> **Principe** : depuis Excel, on met √† jour Access (cr√©ation auto si besoin), on applique les r√®gles de gestion, puis on enrichit la feuille du jour avec `NB Jours de retard` et `Date d√©but retard`.

> **Aucune r√©f√©rence √† ajouter** : tout est en *late binding* (ADO/ADOX cr√©√©s dynamiquement).

Copiez ce module dans **VBA ‚Üí Module standard** et affectez la macro `MAJ_Retards_Daily` √† un bouton.

```vb
Option Explicit

' ====== CONFIG ======
Private Const DB_NAME As String = "Lombard_Retards.accdb"
Private Const T_FLUX As String = "T_FluxRetards"
Private Const T_ARC As String = "T_ArchiveRetards"
Private Const T_TODAY As String = "T_Today"
Private Const T_LOG As String = "T_RunLog"

' Noms des colonnes attendues c√¥t√© Excel (ligne 1)
Private Const COL_BOOKING As String = "Booking"
Private Const COL_PROD As String = "Production Date"
Private Const COL_DOSSIER As String = "NO DOSSIER CREDIT"
' Certains fichiers ont une coquille sur INTERVENANT ‚Üí on g√®re les deux
Private Const COL_INTER As String = "NO INTERVENANT"
Private Const COL_INTER_ALT As String = "NO NTERVENANT"
Private Const COL_INTER_GRP As String = "NO INTERVENANT GRP"
Private Const COL_INTER_GRP_ALT As String = "NO NTERVENANT GRP"
Private Const COL_LIGNE As String = "Ligne"
Private Const COL_LIMITE As String = "Limite"
Private Const COL_CONSO As String = "Consommation"
Private Const COL_SURETE As String = "Montant Surete"
Private Const COL_AM As String = "Montant AM"
Private Const COL_INSUF As String = "Insuffisance"
Private Const COL_TAUX As String = "Taux de couverture"

' Colonnes ajout√©es c√¥t√© Excel
Private Const COL_NBJ As String = "NB Jours de retard"
Private Const COL_DEBUT As String = "Date d√©but retard"

Public Sub MAJ_Retards_Daily()
    On Error GoTo KO
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual

    Dim ws As Worksheet: Set ws = ActiveSheet ' feuille du jour
    Dim dbPath As String: dbPath = ThisWorkbook.Path & Application.PathSeparator & DB_NAME

    ' 1) Cr√©er/ouvrir la base et le sch√©ma
    EnsureDatabaseAndSchema dbPath

    ' 2) Charger la feuille du jour dans T_Today
    Dim rowsImported As Long
    rowsImported = LoadTodayIntoAccess(dbPath, ws)

    ' 3) Appliquer les r√®gles de gestion (UPSERT/ARCHIVE)
    Dim newFlux As Long, contFlux As Long, closedFlux As Long
    ProcessBusinessRules dbPath, newFlux, contFlux, closedFlux

    ' 4) Enrichir la feuille du jour avec les 2 colonnes
    EnrichSheetFromFlux dbPath, ws

    ' 5) Log
    WriteRunLog dbPath, rowsImported, newFlux, contFlux, closedFlux

    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
    MsgBox "Mise √† jour termin√©e :" & vbCrLf & _
           "Import√©s: " & rowsImported & vbCrLf & _
           "Nouveaux flux: " & newFlux & vbCrLf & _
           "Continu√©s: " & contFlux & vbCrLf & _
           "Cl√¥tur√©s: " & closedFlux, vbInformation
    Exit Sub
KO:
    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
    MsgBox "Erreur: " & Err.Description, vbCritical
End Sub

' ====== Access bootstrap ======
Private Sub EnsureDatabaseAndSchema(ByVal dbPath As String)
    If Dir(dbPath, vbNormal) = vbNullString Then
        ' Cr√©er le .accdb
        Dim cat As Object ' ADOX.Catalog
        Set cat = CreateObject("ADOX.Catalog")
        cat.Create "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & dbPath
    End If

    Dim cn As Object: Set cn = GetConn(dbPath)

    ' Cr√©er tables si absentes
    ExecIfNotExists cn, "T_FluxRetards", GetDDL_Flux
    ExecIfNotExists cn, "T_ArchiveRetards", GetDDL_Arc
    ExecIfNotExists cn, "T_Today", GetDDL_Today
    ExecIfNotExists cn, "T_RunLog", GetDDL_Log

    cn.Close: Set cn = Nothing
End Sub

Private Function GetConn(ByVal dbPath As String) As Object
    Dim cn As Object ' ADODB.Connection
    Set cn = CreateObject("ADODB.Connection")
    cn.Open "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & dbPath & ";Persist Security Info=False;"
    Set GetConn = cn
End Function

Private Sub ExecIfNotExists(ByVal cn As Object, ByVal tableName As String, ByVal ddl As String)
    Dim rs As Object: Set rs = cn.OpenSchema(20) ' adSchemaTables
    Dim exists As Boolean: exists = False
    Do While Not rs.EOF
        If StrComp(rs.Fields("TABLE_NAME").Value & "", tableName, vbTextCompare) = 0 Then
            exists = True: Exit Do
        End If
        rs.MoveNext
    Loop
    rs.Close: Set rs = Nothing
    If Not exists Then cn.Execute ddl
End Sub

Private Function GetDDL_Flux() As String
    GetDDL_Flux = _
      "CREATE TABLE T_FluxRetards (" & _
      "Booking TEXT(20) NOT NULL, " & _
      "[NO DOSSIER CREDIT] TEXT(50) NOT NULL, " & _
      "StartDate DATE NOT NULL, " & _
      "LastUpdateDate DATE NOT NULL, " & _
      "NbJoursRetard LONG NOT NULL, " & _
      "WorstInsuffisance DOUBLE, " & _
      "DateWorstInsuffisance DATE, " & _
      "LastInsuffisance DOUBLE, " & _
      "LastTauxCouverture DOUBLE, " & _
      "[NO INTERVENANT] TEXT(50), [NO INTERVENANT GRP] TEXT(50), Ligne TEXT(50), " & _
      "Limite DOUBLE, Consommation DOUBLE, [Montant Surete] DOUBLE, [Montant AM] DOUBLE, [Production Date] DATE, " & _
      "CONSTRAINT PK_Flux PRIMARY KEY (Booking, [NO DOSSIER CREDIT]) );" & _
      "CREATE INDEX IX_Flux_Start ON T_FluxRetards (StartDate);"
End Function

Private Function GetDDL_Arc() As String
    GetDDL_Arc = _
      "CREATE TABLE T_ArchiveRetards (" & _
      "Booking TEXT(20) NOT NULL, [NO DOSSIER CREDIT] TEXT(50) NOT NULL, " & _
      "StartDate DATE NOT NULL, EndDate DATE NOT NULL, Duree LONG NOT NULL, " & _
      "WorstInsuffisance DOUBLE, DateWorstInsuffisance DATE, LastInsuffisance DOUBLE, LastUpdateDate DATE, " & _
      "[NO INTERVENANT] TEXT(50), [NO INTERVENANT GRP] TEXT(50), Ligne TEXT(50), Limite DOUBLE, Consommation DOUBLE, [Montant Surete] DOUBLE, [Montant AM] DOUBLE, [Production Date] DATE, " & _
      "ArchivedAt DATE DEFAULT Date(), CONSTRAINT IX_Arc_Key UNIQUE (Booking, [NO DOSSIER CREDIT], StartDate));" & _
      "CREATE INDEX IX_Arc_End ON T_ArchiveRetards (EndDate);"
End Function

Private Function GetDDL_Today() As String
    GetDDL_Today = _
      "CREATE TABLE T_Today (Booking TEXT(20), [Production Date] DATE, [NO DOSSIER CREDIT] TEXT(50), [NO INTERVENANT] TEXT(50), [NO INTERVENANT GRP] TEXT(50), Ligne TEXT(50), " & _
      "Limite DOUBLE, Consommation DOUBLE, [Montant Surete] DOUBLE, [Montant AM] DOUBLE, Insuffisance DOUBLE, [Taux de couverture] DOUBLE);" & _
      "CREATE INDEX IX_Today_Key ON T_Today (Booking, [NO DOSSIER CREDIT]);"
End Function

Private Function GetDDL_Log() As String
    GetDDL_Log = _
      "CREATE TABLE T_RunLog (RunAt DATETIME NOT NULL, RowsImported LONG, NewFlux LONG, Continued LONG, Closed LONG, [User] TEXT(100));"
End Function

' ====== Import staging ======
Private Function LoadTodayIntoAccess(ByVal dbPath As String, ByVal ws As Worksheet) As Long
    Dim cn As Object: Set cn = GetConn(dbPath)
    cn.Execute "DELETE FROM " & T_TODAY

    ' Pr√©parer l'INSERT param√©tr√©
    Dim sql As String
    sql = "INSERT INTO " & T_TODAY & " (Booking, [Production Date], [NO DOSSIER CREDIT], [NO INTERVENANT], [NO INTERVENANT GRP], Ligne, Limite, Consommation, [Montant Surete], [Montant AM], Insuffisance, [Taux de couverture])" & _
          " VALUES (?,?,?,?,?,?,?,?,?,?,?,?)"

    Dim cmd As Object: Set cmd = CreateObject("ADODB.Command")
    Set cmd.ActiveConnection = cn
    cmd.CommandText = sql
    cmd.CommandType = 1 ' adCmdText

    Dim i As Long
    For i = 1 To 12: cmd.Parameters.Append cmd.CreateParameter(, 200, 1, 255) ' adVarWChar, adParamInput
    Next i

    Dim hdrRow As Long: hdrRow = 1
    Dim lastRow As Long, lastCol As Long
    lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    lastCol = ws.Cells(hdrRow, ws.Columns.Count).End(xlToLeft).Column
    If lastRow <= hdrRow Then LoadTodayIntoAccess = 0: GoTo ExitHere

    Dim map As Object: Set map = CreateObject("Scripting.Dictionary")
    MapCol map, ws, COL_BOOKING
    MapCol map, ws, COL_PROD
    MapCol map, ws, COL_DOSSIER
    MapCol map, ws, COL_INTER, COL_INTER_ALT
    MapCol map, ws, COL_INTER_GRP, COL_INTER_GRP_ALT
    MapCol map, ws, COL_LIGNE
    MapCol map, ws, COL_LIMITE
    MapCol map, ws, COL_CONSO
    MapCol map, ws, COL_SURETE
    MapCol map, ws, COL_AM
    MapCol map, ws, COL_INSUF
    MapCol map, ws, COL_TAUX

    Dim r As Long, n As Long
    cn.BeginTrans
    For r = hdrRow + 1 To lastRow
        cmd.Parameters(0).Value = NzS(ws.Cells(r, map(COL_BOOKING)).Value)
        cmd.Parameters(1).Value = NzS(ws.Cells(r, map(COL_PROD)).Value)
        cmd.Parameters(2).Value = NzS(ws.Cells(r, map(COL_DOSSIER)).Value)
        cmd.Parameters(3).Value = NzS(GetCellMaybe(ws, r, map, COL_INTER, COL_INTER_ALT))
        cmd.Parameters(4).Value = NzS(GetCellMaybe(ws, r, map, COL_INTER_GRP, COL_INTER_GRP_ALT))
        cmd.Parameters(5).Value = NzS(ws.Cells(r, map(COL_LIGNE)).Value)
        cmd.Parameters(6).Value = NzS(ws.Cells(r, map(COL_LIMITE)).Value)
        cmd.Parameters(7).Value = NzS(ws.Cells(r, map(COL_CONSO)).Value)
        cmd.Parameters(8).Value = NzS(ws.Cells(r, map(COL_SURETE)).Value)
        cmd.Parameters(9).Value = NzS(ws.Cells(r, map(COL_AM)).Value)
        cmd.Parameters(10).Value = NzS(ws.Cells(r, map(COL_INSUF)).Value)
        cmd.Parameters(11).Value = NzS(ws.Cells(r, map(COL_TAUX)).Value)
        cmd.Execute , , 128 ' adExecuteNoRecords
        n = n + 1
    Next r
    cn.CommitTrans

    LoadTodayIntoAccess = n
ExitHere:
    cn.Close: Set cn = Nothing
End Function

Private Sub MapCol(ByVal dict As Object, ByVal ws As Worksheet, ByVal name1 As String, Optional ByVal name2 As String = "")
    Dim c As Long: c = FindHeader(ws, name1)
    If c = 0 And Len(name2) > 0 Then c = FindHeader(ws, name2)
    If c = 0 Then Err.Raise vbObjectError + 10, , "Colonne introuvable: " & name1 & IIf(Len(name2) > 0, " (alt: " & name2 & ")", "")
    dict(AddKey(dict, name1)) = c
End Sub

Private Function AddKey(ByVal dict As Object, ByVal k As String) As String
    If Not dict.Exists(k) Then dict.Add k, 0
    AddKey = k
End Function

Private Function FindHeader(ByVal ws As Worksheet, ByVal hdr As String) As Long
    Dim c As Range
    For Each c In ws.Rows(1).Cells
        If Trim$(UCase$(c.Value & "")) = Trim$(UCase$(hdr)) Then
            FindHeader = c.Column: Exit Function
        End If
        If Len(c.Value & "") = 0 Then Exit For ' on s'arr√™te t√¥t si blancs
    Next c
End Function

Private Function GetCellMaybe(ws As Worksheet, r As Long, map As Object, name1 As String, name2 As String) As Variant
    If map.Exists(name1) Then GetCellMaybe = ws.Cells(r, map(name1)).Value: Exit Function
    If map.Exists(name2) Then GetCellMaybe = ws.Cells(r, map(name2)).Value: Exit Function
    GetCellMaybe = Null
End Function

Private Function NzS(v) As Variant
    If IsError(v) Then NzS = Null: Exit Function
    If Len(v & "") = 0 Then NzS = Null Else NzS = v
End Function

' ====== R√®gles de gestion ======
Private Sub ProcessBusinessRules(ByVal dbPath As String, ByRef newFlux As Long, ByRef contFlux As Long, ByRef closedFlux As Long)
    Dim cn As Object: Set cn = GetConn(dbPath)

    ' Nouveaux retards (Insuff < 0 ET pas en flux)
    cn.Execute _
      "INSERT INTO " & T_FLUX & " (Booking, [NO DOSSIER CREDIT], StartDate, LastUpdateDate, NbJoursRetard, " & _
      "WorstInsuffisance, DateWorstInsuffisance, LastInsuffisance, LastTauxCouverture, [NO INTERVENANT], [NO INTERVENANT GRP], Ligne, Limite, Consommation, [Montant Surete], [Montant AM], [Production Date]) " & _
      "SELECT t.Booking, t.[NO DOSSIER CREDIT], Date(), Date(), 1, t.Insuffisance, Date(), t.Insuffisance, t.[Taux de couverture], t.[NO INTERVENANT], t.[NO INTERVENANT GRP], t.Ligne, t.Limite, t.Consommation, t.[Montant Surete], t.[Montant AM], t.[Production Date] " & _
      "FROM " & T_TODAY & " AS t " & _
      "LEFT JOIN " & T_FLUX & " AS f ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "WHERE t.Insuffisance < 0 AND f.Booking IS NULL;"

    newFlux = RecordsAffected(cn)

    ' Retards qui continuent
    cn.Execute _
      "UPDATE " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t " & _
      "ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.NbJoursRetard = f.NbJoursRetard + 1, " & _
      "    f.LastUpdateDate = Date(), " & _
      "    f.LastInsuffisance = t.Insuffisance, " & _
      "    f.LastTauxCouverture = t.[Taux de couverture], " & _
      "    f.WorstInsuffisance = IIF(t.Insuffisance < f.WorstInsuffisance, t.Insuffisance, f.WorstInsuffisance), " & _
      "    f.DateWorstInsuffisance = IIF(t.Insuffisance < f.WorstInsuffisance, Date(), f.DateWorstInsuffisance), " & _
      "    f.[NO INTERVENANT] = t.[NO INTERVENANT], f.[NO INTERVENANT GRP] = t.[NO INTERVENANT GRP], f.Ligne = t.Ligne, " & _
      "    f.Limite = t.Limite, f.Consommation = t.Consommation, f.[Montant Surete] = t.[Montant Surete], f.[Montant AM] = t.[Montant AM], f.[Production Date] = t.[Production Date] " & _
      "WHERE t.Insuffisance < 0;"

    contFlux = RecordsAffected(cn)

    ' Cl√¥tures : en flux mais pas en retard aujourd'hui (absent OU Insuff >= 0)
    cn.Execute _
      "INSERT INTO " & T_ARC & " (Booking, [NO DOSSIER CREDIT], StartDate, EndDate, Duree, WorstInsuffisance, DateWorstInsuffisance, LastInsuffisance, LastUpdateDate, [NO INTERVENANT], [NO INTERVENANT GRP], Ligne, Limite, Consommation, [Montant Surete], [Montant AM], [Production Date]) " & _
      "SELECT f.Booking, f.[NO DOSSIER CREDIT], f.StartDate, Date() AS EndDate, f.NbJoursRetard, f.WorstInsuffisance, f.DateWorstInsuffisance, f.LastInsuffisance, f.LastUpdateDate, f.[NO INTERVENANT], f.[NO INTERVENANT GRP], f.Ligne, f.Limite, f.Consommation, f.[Montant Surete], f.[Montant AM], f.[Production Date] " & _
      "FROM " & T_FLUX & " AS f " & _
      "LEFT JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "WHERE t.Booking IS NULL OR t.Insuffisance >= 0;"

    closedFlux = RecordsAffected(cn)

    ' Supprimer du flux ce qui a √©t√© archiv√©
    cn.Execute _
      "DELETE f.* FROM " & T_FLUX & " AS f " & _
      "LEFT JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "WHERE t.Booking IS NULL OR t.Insuffisance >= 0;"

    cn.Close: Set cn = Nothing
End Sub

Private Function RecordsAffected(ByVal cn As Object) As Long
    On Error Resume Next
    RecordsAffected = cn.RecordsAffected
End Function

' ====== Enrichissement de la feuille ======
Private Sub EnrichSheetFromFlux(ByVal dbPath As String, ByVal ws As Worksheet)
    Dim nbCol As Long: nbCol = EnsureColumn(ws, COL_NBJ)
    Dim dtCol As Long: dtCol = EnsureColumn(ws, COL_DEBUT)

    Dim cn As Object: Set cn = GetConn(dbPath)
    Dim rs As Object: Set rs = CreateObject("ADODB.Recordset")
    rs.Open "SELECT Booking, [NO DOSSIER CREDIT], StartDate, NbJoursRetard FROM " & T_FLUX, cn, 1, 1 'adOpenKeyset, adLockReadOnly

    Dim dict As Object: Set dict = CreateObject("Scripting.Dictionary")
    Do While Not rs.EOF
        dict(rs(0).Value & "||" & rs(1).Value) = Array(rs(2).Value, rs(3).Value)
        rs.MoveNext
    Loop
    rs.Close: Set rs = Nothing
    cn.Close: Set cn = Nothing

    Dim lastRow As Long: lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    If lastRow < 2 Then Exit Sub

    Dim map As Object: Set map = CreateObject("Scripting.Dictionary")
    MapCol map, ws, COL_BOOKING
    MapCol map, ws, COL_DOSSIER
    MapCol map, ws, COL_INSUF

    Dim r As Long
    For r = 2 To lastRow
        Dim k As String: k = CStr(ws.Cells(r, map(COL_BOOKING)).Value) & "||" & CStr(ws.Cells(r, map(COL_DOSSIER)).Value)
        If dict.Exists(k) And Val(ws.Cells(r, map(COL_INSUF)).Value) < 0 Then
            ws.Cells(r, nbCol).Value = dict(k)(1)
            ws.Cells(r, dtCol).Value = dict(k)(0)
        Else
            ws.Cells(r, nbCol).ClearContents
            ws.Cells(r, dtCol).ClearContents
        End If
    Next r

    ws.Columns(nbCol).NumberFormat = "0"
    ws.Columns(dtCol).NumberFormat = "dd/mm/yyyy"
End Sub

Private Function EnsureColumn(ByVal ws As Worksheet, ByVal header As String) As Long
    Dim c As Long: c = FindHeader(ws, header)
    If c > 0 Then EnsureColumn = c: Exit Function
    Dim lastCol As Long: lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column
    ws.Cells(1, lastCol + 1).Value = header
    EnsureColumn = lastCol + 1
End Function

' ====== Logging ======
Private Sub WriteRunLog(ByVal dbPath As String, ByVal rowsImp As Long, ByVal newF As Long, ByVal contF As Long, ByVal closedF As Long)
    Dim cn As Object: Set cn = GetConn(dbPath)
    Dim sql As String
    sql = "INSERT INTO " & T_LOG & " (RunAt, RowsImported, NewFlux, Continued, Closed, [User]) VALUES (Now(), " & _
          rowsImp & ", " & newF & ", " & contF & ", " & closedF & ", '" & Environ$("Username") & "')"
    cn.Execute sql
    cn.Close: Set cn = Nothing
End Sub
```

---

## üìä Requ√™tes Access pr√™tes pour le reporting

- **Q_Flux_Actuel** (vue des retards en cours)
```sql
SELECT Booking, [NO DOSSIER CREDIT], StartDate, NbJoursRetard,
       WorstInsuffisance, DateWorstInsuffisance, LastInsuffisance,
       [NO INTERVENANT], [NO INTERVENANT GRP], Ligne, Limite, Consommation
FROM T_FluxRetards
ORDER BY NbJoursRetard DESC, StartDate ASC;
```

- **Q_Retards_Clotures_Mois** (cl√¥tures par mois)
```sql
SELECT Format(EndDate,'yyyy-mm') AS Mois, COUNT(*) AS Nb, SUM(Duree) AS JoursCumules
FROM T_ArchiveRetards
GROUP BY Format(EndDate,'yyyy-mm')
ORDER BY Mois DESC;
```

- **Q_Top_WorstInsuff** (top insuffisances les plus n√©gatives sur l‚Äôhistorique)
```sql
SELECT TOP 50 Booking, [NO DOSSIER CREDIT], WorstInsuffisance, DateWorstInsuffisance, StartDate, EndDate, Duree
FROM T_ArchiveRetards
ORDER BY WorstInsuffisance ASC; -- ASC = plus n√©gatif en premier
```

- **Q_Duree_Moyenne_Par_Ligne**
```sql
SELECT Ligne, AVG(Duree) AS DureeMoy
FROM T_ArchiveRetards
GROUP BY Ligne
ORDER BY DureeMoy DESC;
```

---

## üöÄ Mise en place (une fois)
1. Placez le bouton sur votre feuille et assignez la macro `MAJ_Retards_Daily`.
2. Laissez le fichier Excel **dans un dossier o√π vous avez droit d‚Äô√©criture**. La base `Lombard_Retards.accdb` sera cr√©√©e **√† c√¥t√© du classeur**.
3. V√©rifiez que les **en-t√™tes** de la ligne 1 sont identiques (la macro g√®re la coquille ¬´ NO NTERVENANT ¬ª).
4. Lancez le bouton chaque jour **apr√®s avoir coll√©/rafra√Æchi** la feuille du jour.

---

## ‚úÖ Points cl√©s de qualit√©
- **Performant** : staging `T_Today` + op√©rations SQL en masse, pas de boucles lourdes sur la base.
- **Tra√ßabilit√©** : `T_RunLog` garde le journal (import, nouveaux, continus, cl√¥tur√©s).
- **Robuste** : PK composite, index, champs typ√©s, pires insuffisances au sens *le plus n√©gatif*.
- **√âvolutif** : tables s√©par√©es (flux/archives), requ√™tes reporting, champs contextuels optionnels.

---

## üìù Note sur ¬´ Max Insuffisance ¬ª
Ici **WorstInsuffisance = valeur la plus n√©gative** observ√©e pendant l‚Äô√©pisode (c‚Äôest g√©n√©ralement ce que l‚Äôon veut pour une insuffisance). Si vous pr√©f√©rez ¬´ l‚Äôamplitude ¬ª (valeur absolue la plus grande), on peut facilement adapter la logique.

---

## üîÅ Variantes possibles (faciles √† ajouter)
- Sortir un **CSV/Graphique** automatique de suivi par jour/semaine.
- Remonter les **Dates de 1er/dernier jour de retard** par `Booking`/`Dossier` pour un usage risque/comit√©.
- Gestion **jours ouvr√©s** (si vous ne voulez pas compter les week-ends).

---

## ‚ùìFAQ rapide
- **Et si la m√™me cl√© n‚Äôappara√Æt plus du tout dans le fichier du jour ?** ‚Üí elle est consid√©r√©e **cl√¥tur√©e** ce jour.
- **Et si une cl√© r√©appara√Æt plus tard avec un nouvel √©pisode ?** ‚Üí un **nouvel enregistrement** sera cr√©√© dans `T_FluxRetards` puis **archiv√©** √† la fin de ce nouvel √©pisode. L‚Äôhistorique aura donc **plusieurs √©pisodes** par cl√©.
- **Puis-je lancer la macro plusieurs fois le m√™me jour ?** ‚Üí Oui, mais elle incr√©mentera d‚Äôun jour √† chaque ex√©cution. Si vous avez besoin de verrouiller √† **une fois par jour**, on peut ajouter une garde (date du dernier run dans `T_RunLog`).

