Option Explicit

Private Const TEST_MODE As Boolean = True      ' <-- Mets False en PROD
Private Const TEST_STEP_DAYS As Long = 1       ' pas d'avancement à chaque run (1 = +1 jour)
Private Const TEST_START_DATE As Date = #1/1/2024#  ' date de départ de la simu (US literal mm/dd/yyyy)
Private Const T_CFG As String = "T_Config"

' ====== CONFIG ======
Private Const DB_NAME As String = "Lombards2.accdb"
Private Const T_FLUX As String = "T_Flux"
Private Const T_ARC As String = "T_Archive"
Private Const T_TODAY As String = "T_Today"
Private Const T_HIST As String = "T_HistoryInsuff"
Private Const T_LOG As String = "T_RunLog"
Private Const T_CLOSE As String = "T_CloseBuf"

' En-têtes Excel (ligne 1)
Private Const COL_BOOKING As String = "Booking"
Private Const COL_PROD As String = "Production Date"
Private Const COL_DOSSIER As String = "NO DOSSIER CREDIT"
Private Const COL_INTER As String = "NO INTERVENANT"
Private Const COL_INTER_ALT As String = "NO NTERVENANT"
Private Const COL_INTER_GRP As String = "NO INTERVENANT GRP"
Private Const COL_INTER_GRP_ALT As String = "NO NTERVENANT GRP"

Private Const COL_LIMITE As String = "Limite"
Private Const COL_CONSO As String = "Consommation"

Private Const COL_MVG As String = "Montant VG (valeur de gage-LTV)"
Private Const COL_MVG_ALT As String = "Montant VG"
Private Const COL_MAM As String = "Montant AM"
Private Const COL_MSL As String = "Montant SL"

Private Const COL_IVG As String = "Insuffisance VG"
Private Const COL_IAM As String = "Insuffisance AM"
Private Const COL_ISL As String = "Insuffisance SL"

' Colonnes ajoutées (feuille)
Private Const COL_NBJ_VG As String = "NB Jours retard VG"
Private Const COL_DEB_VG As String = "Date début VG"
Private Const COL_FIN_VG As String = "Date fin VG"

Private Const COL_NBJ_AM As String = "NB Jours retard AM"
Private Const COL_DEB_AM As String = "Date début AM"
Private Const COL_FIN_AM As String = "Date fin AM"

Private Const COL_NBJ_SL As String = "NB Jours retard SL"
Private Const COL_DEB_SL As String = "Date début SL"
Private Const COL_FIN_SL As String = "Date fin SL"

Private Const COL_FLAG_NA As String = "Dépassement non autorisé"
Private Const adVarWChar = 202, adDouble = 5, adDate = 7, adCmdText = 1, adExecuteNoRecords = 128

' ====== PUBLIC ENTRY ======
Public Sub Main_Histo()

    'On Error GoTo KO
    Call Optimize(True)

    Dim ws As Worksheet, cn As ADODB.Connection, TimerStart As Double, dbPath As String, rowsImported As Long, newFlux As Long, contFlux As Long, closedFlux As Long
    
    TimerStart = FctTimer(True)
    
    Set ws = ActiveSheet
    dbPath = ThisWorkbook.Path & Application.PathSeparator & DB_NAME
    Set cn = GetConn(dbPath) 'Set cn = GetConnTuned(dbPath)
    
    '1) DB + schéma
    'Call EnsureDatabaseAndSchema(cn, dbPath)

    '2) Staging du jour
    'rowsImported = LoadTodayIntoAccessFast(cn, ws)
    
    rowsImported = BulkLoadTodayFromExcel_Fast(cn, _
                    wbPath:=ThisWorkbook.FullName, sheetName:=ActiveSheet.name, usedRangeFromExcel:=ActiveSheet.UsedRange.Address(False, False))

    '2b) Normaliser et neutraliser NULL
    Call NormalizeToday(cn)

    '3) Historique quotidien
    Call AppendHistory(cn)

    '4) Règles de gestion 3-en-1
    Call ProcessBusinessRules_3in1_NoNzIif(cn, newFlux, contFlux, closedFlux)

    '5) Enrichir la feuille
    Call EnrichSheetFromFlux_3in1(cn, ws)

    '6) Log
    Call WriteRunLog(cn, rowsImported, newFlux, contFlux, closedFlux)

    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
    MsgBox "Mise à jour terminée :" & vbCrLf & _
           "Importés : " & rowsImported & vbCrLf & _
           "Nouveaux flux : " & newFlux & vbCrLf & _
           "Continués : " & contFlux & vbCrLf & _
           "Clôturés : " & closedFlux, vbInformation
                
    If TEST_MODE Then Call BumpSimDate(cn)
    
    cn.Close: Set cn = Nothing
    Call Optimize(False)
    MsgBox FctTimer(False, FctTimer(True) - TimerStart), vbOKOnly, "LLCR HISTO"
    Exit Sub
KO:

    If Not cn Is Nothing Then If cn.State = 1 Then cn.Close
    Call Optimize(False)
    MsgBox "Erreur : " & Err.description, vbCritical
    
End Sub

' ====== DB bootstrap ======
Private Function GetConn(ByVal dbPath As String) As ADODB.Connection

    Dim cn As ADODB.Connection
    
    Set cn = CreateObject("ADODB.Connection")
    On Error Resume Next
    cn.Open "Provider=Microsoft.ACE.OLEDB.16.0;Data Source=" & dbPath & ";Persist Security Info=False;"
    If cn.State = 0 Then cn.Open "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & dbPath & ";Persist Security Info=False;"
    On Error GoTo 0
    Set GetConn = cn
    
End Function

Sub CheckOLEDBProviders()

    Dim rs As Object
    Set rs = CreateObject("ADODB.Connection")
    Debug.Print rs.Provider ' Liste les fournisseurs OLE DB disponibles
    
End Sub

Private Function GetConnTuned(ByVal dbPath As String) As ADODB.Connection

    'Connexion "tunée" (tampon ACE plus large, verrouillage optimisé)
        ' Persist Security Info=False, pour ne pas conserver les informations de sécurité après l'ouverture de la connexion.
        '- Jet OLEDB:Database Locking Mode=1 (recommandé pour env multi-utilisateurs) : Indique mode verrouillage.
        '- Jet OLEDB:Max Buffer Size=4096 (par défaut  512 Ko max 16384) : Définit la taille maximale du tampon en kilo-octets (4 Mo ici).
        '- Une taille de tampon plus grande peut améliorer les performances en accélérant la récupération des données, notamment pour les grandes bases de données.
        '- OLE DB Services=-2 : Désactive certains services OLE DB comme le pooling des connexions ou la gestion des curseurs,
    Dim cn As Object, cs As String, prop As Object
    
    Set cn = CreateObject("ADODB.Connection")

    cs = "Provider=Microsoft.ACE.OLEDB.16.0;" & "Data Source=" & dbPath & ";" & "Persist Security Info=False;" & _
         "Jet OLEDB:Database Locking Mode=1;" & "OLE DB Services=-2;"
         
    On Error Resume Next
        cn.Open cs
        cn.Properties("Jet OLEDB:Max Buffer Size") = 4096
        cn.Properties("Jet OLEDB:Page Timeout") = 2000 ' Timeout des pages (2 secondes)
        cn.Properties("Jet OLEDB:Flush Transaction Timeout") = 1000 ' Timeout des transactions (1 seconde
        If cn.State = 0 Then
            cs = Replace(cs, "16.0", "12.0")
            cn.Open cs
        End If
    On Error GoTo 0

    'Lister toutes les propriétés disponibles pour le fournisseur
    'Debug.Print "Propriétés disponibles :"
    'For Each prop In cn.Properties
        'Debug.Print "Nom : " & prop.name & " | Valeur : " & prop.Value
    'Next prop
    
    Set GetConnTuned = cn
    Set cn = Nothing
      
End Function

' ====== Staging ======
'Gros gain : types ADO corrects (date/double/texte), un seul Command préparé, transaction englobante.
Public Function LoadTodayIntoAccessFast(ByVal cn As ADODB.Connection, ByVal ws As Worksheet) As Long

    Dim cmd As Object, vData As Variant, map As New Dictionary, sql As String, lastCol As Long, r As Long, n As Long, lastRow As Long, rowOffset As Long
    
    cn.Execute "DELETE FROM " & T_TODAY, , adExecuteNoRecords

    sql = "INSERT INTO " & T_TODAY & " (Booking,[Production Date],[NO DOSSIER CREDIT],[NO INTERVENANT],[NO INTERVENANT GRP]," & _
          "Limite,Consommation,[Montant VG],[Montant AM],[Montant SL],[Insuffisance VG],[Insuffisance AM],[Insuffisance SL]) " & _
          "VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?)"

    Set cmd = CreateObject("ADODB.Command")
    With cmd
        .ActiveConnection = cn
        .CommandType = adCmdText
        .CommandText = sql
        .Parameters.Append .CreateParameter(, adVarWChar, 1, 20)   ' Booking
        .Parameters.Append .CreateParameter(, adDate, 1)           ' Production Date
        .Parameters.Append .CreateParameter(, adVarWChar, 1, 50)   ' NDC
        .Parameters.Append .CreateParameter(, adVarWChar, 1, 50)   ' Intervenant
        .Parameters.Append .CreateParameter(, adVarWChar, 1, 50)   ' Intervenant Grp
        .Parameters.Append .CreateParameter(, adDouble, 1)         ' Limite
        .Parameters.Append .CreateParameter(, adDouble, 1)         ' Conso
        .Parameters.Append .CreateParameter(, adDouble, 1)         ' MVG
        .Parameters.Append .CreateParameter(, adDouble, 1)         ' MAM
        .Parameters.Append .CreateParameter(, adDouble, 1)         ' MSL
        .Parameters.Append .CreateParameter(, adDouble, 1)         ' IVG
        .Parameters.Append .CreateParameter(, adDouble, 1)         ' IAM
        .Parameters.Append .CreateParameter(, adDouble, 1)         ' ISL
        .Prepared = True
    End With

    Call MapCol(map, ws, COL_BOOKING)
    Call MapCol(map, ws, COL_PROD)
    Call MapCol(map, ws, COL_DOSSIER)
    Call MapCol(map, ws, COL_INTER, COL_INTER_ALT)
    Call MapCol(map, ws, COL_INTER_GRP, COL_INTER_GRP_ALT)
    Call MapCol(map, ws, COL_LIMITE)
    Call MapCol(map, ws, COL_CONSO)
    Call MapCol(map, ws, COL_MVG, COL_MVG_ALT)
    Call MapCol(map, ws, COL_MAM)
    Call MapCol(map, ws, COL_MSL)
    Call MapCol(map, ws, COL_IVG)
    Call MapCol(map, ws, COL_IAM)
    Call MapCol(map, ws, COL_ISL)

    lastRow = ws.Cells(ws.rows.count, 1).End(xlUp).row
    If lastRow < 2 Then Exit Function

    'Lecture en bloc pour réduire les accès COM
    lastCol = ws.Cells(1, ws.Columns.count).End(xlToLeft).Column
    vData = ws.Range(ws.Cells(2, 1), ws.Cells(lastRow, lastCol)).Value

    rowOffset = 2
    cn.BeginTrans
    With cmd
        For r = 1 To UBound(vData, 1)
            .Parameters(0).Value = vData(r, map(COL_BOOKING))             ' Booking
            .Parameters(1).Value = vData(r, map(COL_PROD))                ' Production Date
            .Parameters(2).Value = vData(r, map(COL_DOSSIER))             ' NDC
            .Parameters(3).Value = vData(r, map(COL_INTER))               ' Interv
            .Parameters(4).Value = vData(r, map(COL_INTER_GRP))           ' IntervGrp
            .Parameters(5).Value = vData(r, map(COL_LIMITE))              ' Limite
            .Parameters(6).Value = vData(r, map(COL_CONSO))               ' Conso
            .Parameters(7).Value = vData(r, map(COL_MVG))                 ' MVG
            .Parameters(8).Value = vData(r, map(COL_MAM))                 ' MAM
            .Parameters(9).Value = vData(r, map(COL_MSL))                 ' MSL
            .Parameters(10).Value = vData(r, map(COL_IVG))                ' IVG
            .Parameters(11).Value = vData(r, map(COL_IAM))                ' IAM
            .Parameters(12).Value = vData(r, map(COL_ISL))                ' ISL
            .Execute , , adExecuteNoRecords
            n = n + 1
        Next
    End With
    cn.CommitTrans
    LoadTodayIntoAccessFast = n
    
End Function

'=====================================================================
'  IMPORT MASSIF EXCEL -> ACCESS (turbo)
'  - Drop T_TODAY + SELECT INTO (création table) = plus rapide que DELETE + INSERT
'  - Lecture bornée au UsedRange pour éviter le scan de lignes vides
'  - Normalisation inline (Trim/UCase/Nz/Date fallback) pour éviter des UPDATE
'  - Recréation de l’index (Booking, NO DOSSIER CREDIT)
' =====================================================================
                                 
Public Function BulkLoadTodayFromExcel_Fast(ByVal cn As ADODB.Connection, ByVal wbPath As String, ByVal sheetName As String, _
            Optional ByVal usedRangeFromExcel As String = "") As Long


    'DROP + SELECT INTO : Access/ACE alloue une table neuve et écrit séquentiellement (évite le DELETE)
    '(pas de journalisation ligne/ligne comme un DELETE suivi d’un INSERT).
    
    'Plage bornée(UsedRange) A1:… : ACE ne parcourt que les cellules utiles ; les classeurs “larges” gagnent énormément.
    'Normalisation dans le SELECT : tu supprimes 7–8 UPDATE post-import
    'Index recréé seulement après import
    
    Dim rows As Long, lastCell As String, excelSpec As String, ext As String, suffixRange As String, srcTable As String, sqlInto As String
    
    ext = LCase$(Mid$(wbPath, InStrRev(wbPath, ".") + 1))

    Select Case ext
        Case "xlsx", "xlsm": excelSpec = "Excel 12.0 Xml"
        Case "xlsb":         excelSpec = "Excel 12.0"
        Case "xls":          excelSpec = "Excel 8.0"
        Case Else:           excelSpec = "Excel 12.0 Xml"
    End Select

    'Si on reçoit une plage (ex: A1:N25000), on l’applique: [Feuille$A1:N25000]
    If Len(usedRangeFromExcel) > 0 Then
        'Forcer l’ancrage à partir de A1 si jamais le UsedRange commence plus à droite/plus bas:
        '(on présume tes entêtes en ligne 1, colonnes contiguës)
        lastCell = Split(usedRangeFromExcel, ":")(UBound(Split(usedRangeFromExcel, ":")))
        suffixRange = "A1:" & lastCell
    Else
        suffixRange = "" 'pas de plage => ACE lira tout l’onglet (plus lent)
    End If

    srcTable = "[" & excelSpec & ";HDR=YES;IMEX=0;Database=" & wbPath & "].[" & sheetName & "$" & suffixRange & "]"

    ' NOTE colonnes alternatives gérées inline:
    ' - NO INTERVENANT / NO NTERVENANT
    ' - NO INTERVENANT GRP / NO NTERVENANT GRP
    ' - Montant VG (valeur de gage-LTV) / Montant VG
    ' Normalisation inline:
    '  * Booking => UCase(Trim())
    '  * NO DOSSIER CREDIT => Trim()
    '  * Production Date => fallback Date() si vide
    '  * Numériques => CDbl(Nz(...,0))
    
    sqlInto = _
      "SELECT " & _
      "  UCase(Trim([Booking])) AS Booking," & _
      "  CDate([Production Date]) AS [Production Date]," & _
      "  Trim([NO DOSSIER CREDIT]) AS [NO DOSSIER CREDIT]," & _
      "  CStr([NO INTERVENANT]) AS [NO INTERVENANT]," & _
      "  CStr([NO INTERVENANT GRP]) AS [NO INTERVENANT GRP]," & _
      "  CDbl([Limite]) AS Limite," & _
      "  CDbl([Consommation]) AS Consommation," & _
      "  CDbl([Montant VG]) AS [Montant VG]," & _
      "  CDbl([Montant AM]) AS [Montant AM]," & _
      "  CDbl([Montant SL]) AS [Montant SL]," & _
      "  CDbl([Insuffisance VG]) AS [Insuffisance VG]," & _
      "  CDbl([Insuffisance AM]) AS [Insuffisance AM]," & _
      "  CDbl([Insuffisance SL]) AS [Insuffisance SL] " & _
      "INTO " & T_TODAY & " " & _
      "FROM " & srcTable & ";"
  
    On Error GoTo FAIL
    cn.BeginTrans

    ' Drop T_TODAY (si existe) pour éviter DELETE massif + conserver des pages propres
    On Error Resume Next
        cn.Execute "DROP TABLE " & T_TODAY, , 128
    On Error GoTo 0


    Debug.Print sqlInto
    'Création directe de T_TODAY via SELECT INTO (types inférés par les casts)
    cn.Execute sqlInto, , 128

    'Index clé pour accélérer les joins/updates suivants
    On Error Resume Next
        cn.Execute "CREATE INDEX IX_Today_Key ON " & T_TODAY & " (Booking, [NO DOSSIER CREDIT])", , 128
    On Error GoTo 0

    cn.CommitTrans
    BulkLoadTodayFromExcel_Fast = rows
    Exit Function

FAIL:
    On Error Resume Next
    cn.RollbackTrans
    Err.Raise Err.Number, , Err.description
    
End Function

'Alias anti-typo si tu appelais "Accces"
Public Function LoadTodayIntoAccces(ByVal dbPath As String, ByVal ws As Worksheet) As Long
    LoadTodayIntoAccces = LoadTodayIntoAccess(dbPath, ws)
End Function

' ====== Normalisation ======
Private Sub NormalizeToday(ByVal cn As ADODB.Connection)

    cn.Execute "UPDATE " & T_TODAY & " SET Booking = UCase(Trim(Booking));"
    cn.Execute "UPDATE " & T_TODAY & " SET [NO DOSSIER CREDIT] = Trim([NO DOSSIER CREDIT]);"
    cn.Execute "UPDATE " & T_TODAY & " SET [Production Date] = Date() WHERE [Production Date] IS NULL;"

    cn.Execute "UPDATE " & T_TODAY & " SET Limite=0 WHERE Limite IS NULL;"
    cn.Execute "UPDATE " & T_TODAY & " SET Consommation=0 WHERE Consommation IS NULL;"
    cn.Execute "UPDATE " & T_TODAY & " SET [Montant VG]=0 WHERE [Montant VG] IS NULL;"
    cn.Execute "UPDATE " & T_TODAY & " SET [Montant AM]=0 WHERE [Montant AM] IS NULL;"
    cn.Execute "UPDATE " & T_TODAY & " SET [Montant SL]=0 WHERE [Montant SL] IS NULL;"
    cn.Execute "UPDATE " & T_TODAY & " SET [Insuffisance VG]=0 WHERE [Insuffisance VG] IS NULL;"
    cn.Execute "UPDATE " & T_TODAY & " SET [Insuffisance AM]=0 WHERE [Insuffisance AM] IS NULL;"
    cn.Execute "UPDATE " & T_TODAY & " SET [Insuffisance SL]=0 WHERE [Insuffisance SL] IS NULL;"

    'Si doublons de clé avec dates différentes, garde la plus récente
    cn.Execute _
      "DELETE FROM " & T_TODAY & " AS a " & _
      "WHERE EXISTS (SELECT 1 FROM " & T_TODAY & " AS b " & _
      "              WHERE b.Booking=a.Booking AND b.[NO DOSSIER CREDIT]=a.[NO DOSSIER CREDIT] " & _
      "                AND b.[Production Date] > a.[Production Date]);"
      
      
    '--- MODE SIMULATION : force la Production Date ---
    If TEST_MODE Then
        Dim dSim As Date
        dSim = GetSimDate(cn)
        cn.Execute "UPDATE " & T_TODAY & " SET [Production Date] = " & SqlDate(dSim) & ";"
    End If
  
End Sub


' ====== Historique quotidien ======
Private Sub AppendHistory(ByVal cn As ADODB.Connection)


    'VG / AM / SL (insert si pas déjà inséré au même jour)
    cn.Execute _
      "INSERT INTO " & T_HIST & " (Booking, [NO DOSSIER CREDIT], Nature, [Production Date], Insuffisance, Consommation, Limite, [Montant]) " & _
      "SELECT t.Booking, t.[NO DOSSIER CREDIT], 'VG', t.[Production Date], t.[Insuffisance VG], t.Consommation, t.Limite, t.[Montant VG] " & _
      "FROM " & T_TODAY & " AS t " & _
      "WHERE NOT EXISTS (SELECT 1 FROM " & T_HIST & " h WHERE h.Booking=t.Booking AND h.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] AND h.Nature='VG' AND h.[Production Date]=t.[Production Date]);"

    cn.Execute _
      "INSERT INTO " & T_HIST & " (Booking, [NO DOSSIER CREDIT], Nature, [Production Date], Insuffisance, Consommation, Limite, [Montant]) " & _
      "SELECT t.Booking, t.[NO DOSSIER CREDIT], 'AM', t.[Production Date], t.[Insuffisance AM], t.Consommation, t.Limite, t.[Montant AM] " & _
      "FROM " & T_TODAY & " AS t " & _
      "WHERE NOT EXISTS (SELECT 1 FROM " & T_HIST & " h WHERE h.Booking=t.Booking AND h.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] AND h.Nature='AM' AND h.[Production Date]=t.[Production Date]);"

    cn.Execute _
      "INSERT INTO " & T_HIST & " (Booking, [NO DOSSIER CREDIT], Nature, [Production Date], Insuffisance, Consommation, Limite, [Montant]) " & _
      "SELECT t.Booking, t.[NO DOSSIER CREDIT], 'SL', t.[Production Date], t.[Insuffisance SL], t.Consommation, t.Limite, t.[Montant SL] " & _
      "FROM " & T_TODAY & " AS t " & _
      "WHERE NOT EXISTS (SELECT 1 FROM " & T_HIST & " h WHERE h.Booking=t.Booking AND h.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] AND h.Nature='SL' AND h.[Production Date]=t.[Production Date]);"

    'Dépassement non autorisé => 'YES'
    cn.Execute _
      "UPDATE " & T_HIST & " AS h INNER JOIN " & T_TODAY & " AS t " & _
      "ON h.Booking=t.Booking AND h.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] AND h.[Production Date]=t.[Production Date] " & _
      "SET h.DepassementNA='YES' " & _
      "WHERE Abs(t.Consommation) > t.Limite;"
      
    'MAJ DepassementNA en 1 passe
    cn.Execute _
    "UPDATE " & T_HIST & " AS h " & _
    "INNER JOIN " & T_TODAY & " AS t " & _
    "ON h.Booking=t.Booking AND h.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] AND h.[Production Date]=t.[Production Date] " & _
    "SET h.DepassementNA=IIf(Abs(t.Consommation)>t.Limite,'YES','NO');", , 128
    
End Sub

' ====== Règles de gestion (3-en-1) ======
Private Sub ProcessBusinessRules_3in1_NoNzIif(ByVal cn As ADODB.Connection, ByRef newFlux As Long, ByRef contFlux As Long, ByRef closedFlux As Long)
    
    Dim nNew As Long, nCont As Long, nClosed As Long
    
    On Error GoTo ROLLBACK
    
    cn.BeginTrans

    '1)INSERT de nouvelles clés en FLUX si au moins une insuff < 0 (cast explicites)
    cn.Execute _
      "INSERT INTO " & T_FLUX & " (" & _
      "  Booking, [NO DOSSIER CREDIT], Limite, Consommation, [Montant VG], [Montant AM], [Montant SL], [Production Date], [NO INTERVENANT], [NO INTERVENANT GRP]" & _
      ") " & _
      "SELECT " & _
      "  CStr(t.Booking) AS Booking, " & _
      "  CStr(t.[NO DOSSIER CREDIT]) AS NDC, " & _
      "  CDbl(t.Limite) AS Limite, " & _
      "  CDbl(t.Consommation) AS Consommation, " & _
      "  CDbl(t.[Montant VG]) AS MVG, " & _
      "  CDbl(t.[Montant AM]) AS MAM, " & _
      "  CDbl(t.[Montant SL]) AS MSL, " & _
      "  CDate(t.[Production Date]) AS ProdDate, " & _
      "  CStr(t.[NO INTERVENANT]) AS Interv, " & _
      "  CStr(t.[NO INTERVENANT GRP]) AS IntervGrp " & _
      "FROM " & T_TODAY & " AS t " & _
      "WHERE (t.[Insuffisance VG] < 0 OR t.[Insuffisance AM] < 0 OR t.[Insuffisance SL] < 0) " & _
      "  AND NOT EXISTS (" & _
      "      SELECT 1 FROM " & T_FLUX & " AS f " & _
      "      WHERE f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT]" & _
      "  );"
      
    nNew = RecordsAffected(cn) 'cn.RecordsAffected

    '2) Détermine DepassementNA ('YES'/'NO') sur le FLUX
    cn.Execute _
      "UPDATE " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t " & _
      "ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.DepassementNA='YES' WHERE Abs(t.Consommation) > t.Limite;"
    cn.Execute _
      "UPDATE " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t " & _
      "ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.DepassementNA='NO' WHERE NOT (Abs(t.Consommation) > t.Limite);"

    '3) Démarrages VG/AM/SL
    cn.Execute _
      "UPDATE " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.VG_StartDate=t.[Production Date], f.VG_LastUpdateDate=t.[Production Date], f.VG_NbJoursRetard=1, f.VG_WorstInsuffisance=t.[Insuffisance VG], f.VG_DateWorstInsuffisance=t.[Production Date], f.VG_LastInsuffisance=t.[Insuffisance VG] " & _
      "WHERE f.VG_StartDate IS NULL AND t.[Insuffisance VG] < 0;"
    nNew = nNew + RecordsAffected(cn)

    cn.Execute _
      "UPDATE " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.AM_StartDate=t.[Production Date], f.AM_LastUpdateDate=t.[Production Date], f.AM_NbJoursRetard=1, f.AM_WorstInsuffisance=t.[Insuffisance AM], f.AM_DateWorstInsuffisance=t.[Production Date], f.AM_LastInsuffisance=t.[Insuffisance AM] " & _
      "WHERE f.AM_StartDate IS NULL AND t.[Insuffisance AM] < 0;"
    nNew = nNew + RecordsAffected(cn)

    cn.Execute _
      "UPDATE " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.SL_StartDate=t.[Production Date], f.SL_LastUpdateDate=t.[Production Date], f.SL_NbJoursRetard=1, f.SL_WorstInsuffisance=t.[Insuffisance SL], f.SL_DateWorstInsuffisance=t.[Production Date], f.SL_LastInsuffisance=t.[Insuffisance SL] " & _
      "WHERE f.SL_StartDate IS NULL AND t.[Insuffisance SL] < 0;"
    nNew = nNew + RecordsAffected(cn)

    '4) Continuations + mise à jour "pire"
    'VG
    cn.Execute _
      "UPDATE " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.VG_NbJoursRetard=f.VG_NbJoursRetard + DateDiff('d', f.VG_LastUpdateDate, t.[Production Date]), " & _
      "    f.VG_LastUpdateDate=t.[Production Date], f.VG_LastInsuffisance=t.[Insuffisance VG], " & _
      "    f.Limite=t.Limite, f.Consommation=t.Consommation, f.[Montant VG]=t.[Montant VG], f.[Montant AM]=t.[Montant AM], f.[Montant SL]=t.[Montant SL], f.[Production Date]=t.[Production Date], " & _
      "    f.[NO INTERVENANT]=t.[NO INTERVENANT], f.[NO INTERVENANT GRP]=t.[NO INTERVENANT GRP] " & _
      "WHERE t.[Insuffisance VG] < 0 AND f.VG_StartDate IS NOT NULL AND t.[Production Date] > f.VG_LastUpdateDate;"
    nCont = RecordsAffected(cn)

    cn.Execute _
      "UPDATE " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.VG_WorstInsuffisance=t.[Insuffisance VG], f.VG_DateWorstInsuffisance=t.[Production Date] " & _
      "WHERE t.[Insuffisance VG] < 0 AND f.VG_StartDate IS NOT NULL AND (f.VG_WorstInsuffisance IS NULL OR t.[Insuffisance VG] < f.VG_WorstInsuffisance);"

    'AM
    cn.Execute _
      "UPDATE " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.AM_NbJoursRetard=f.AM_NbJoursRetard + DateDiff('d', f.AM_LastUpdateDate, t.[Production Date]), " & _
      "    f.AM_LastUpdateDate=t.[Production Date], f.AM_LastInsuffisance=t.[Insuffisance AM], " & _
      "    f.Limite=t.Limite, f.Consommation=t.Consommation, f.[Montant VG]=t.[Montant VG], f.[Montant AM]=t.[Montant AM], f.[Montant SL]=t.[Montant SL], f.[Production Date]=t.[Production Date], " & _
      "    f.[NO INTERVENANT]=t.[NO INTERVENANT], f.[NO INTERVENANT GRP]=t.[NO INTERVENANT GRP] " & _
      "WHERE t.[Insuffisance AM] < 0 AND f.AM_StartDate IS NOT NULL AND t.[Production Date] > f.AM_LastUpdateDate;"
    nCont = nCont + RecordsAffected(cn)

    cn.Execute _
      "UPDATE " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.AM_WorstInsuffisance=t.[Insuffisance AM], f.AM_DateWorstInsuffisance=t.[Production Date] " & _
      "WHERE t.[Insuffisance AM] < 0 AND f.AM_StartDate IS NOT NULL AND (f.AM_WorstInsuffisance IS NULL OR t.[Insuffisance AM] < f.AM_WorstInsuffisance);"

    'SL
    cn.Execute _
      "UPDATE " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.SL_NbJoursRetard=f.SL_NbJoursRetard + DateDiff('d', f.SL_LastUpdateDate, t.[Production Date]), " & _
      "    f.SL_LastUpdateDate=t.[Production Date], f.SL_LastInsuffisance=t.[Insuffisance SL], " & _
      "    f.Limite=t.Limite, f.Consommation=t.Consommation, f.[Montant VG]=t.[Montant VG], f.[Montant AM]=t.[Montant AM], f.[Montant SL]=t.[Montant SL], f.[Production Date]=t.[Production Date], " & _
      "    f.[NO INTERVENANT]=t.[NO INTERVENANT], f.[NO INTERVENANT GRP]=t.[NO INTERVENANT GRP] " & _
      "WHERE t.[Insuffisance SL] < 0 AND f.SL_StartDate IS NOT NULL AND t.[Production Date] > f.SL_LastUpdateDate;"
    nCont = nCont + RecordsAffected(cn)

    cn.Execute _
      "UPDATE " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.SL_WorstInsuffisance=t.[Insuffisance SL], f.SL_DateWorstInsuffisance=t.[Production Date] " & _
      "WHERE t.[Insuffisance SL] < 0 AND f.SL_StartDate IS NOT NULL AND (f.SL_WorstInsuffisance IS NULL OR t.[Insuffisance SL] < f.SL_WorstInsuffisance);"

    '5) Rafraîchir DepassementNA après continuations
    cn.Execute _
      "UPDATE " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t " & _
      "ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.DepassementNA='YES' WHERE Abs(t.Consommation) > t.Limite;"
    cn.Execute _
      "UPDATE " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t " & _
      "ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.DepassementNA='NO' WHERE NOT (Abs(t.Consommation) > t.Limite);"

    '6) Archivage (clé absente ou nature revenue >= 0)
    
    Call BuildCloseBuffer(cn)
    nClosed = InsertCloseBufferToArchive(cn)
    
    'VG
    'cn.Execute _
      "INSERT INTO " & T_ARC & " (Booking, [NO DOSSIER CREDIT], VG_StartDate, VG_EndDate, VG_Duree, VG_WorstInsuffisance, VG_DateWorstInsuffisance, VG_LastInsuffisance, VG_LastUpdateDate, " & _
      "Limite, Consommation, [Montant VG], [Montant AM], [Montant SL], [Production Date], [NO INTERVENANT], [NO INTERVENANT GRP], DepassementNA, FlagVG, FlagAM, FlagSL) " & _
      "SELECT f.Booking, f.[NO DOSSIER CREDIT], f.VG_StartDate, f.VG_LastUpdateDate, f.VG_NbJoursRetard, f.VG_WorstInsuffisance, f.VG_DateWorstInsuffisance, f.VG_LastInsuffisance, f.VG_LastUpdateDate, " & _
      "f.Limite, f.Consommation, f.[Montant VG], f.[Montant AM], f.[Montant SL], f.[Production Date], f.[NO INTERVENANT], f.[NO INTERVENANT GRP], f.DepassementNA, 'YES','NO','NO' " & _
      "FROM " & T_FLUX & " AS f LEFT JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "WHERE f.VG_StartDate IS NOT NULL AND t.Booking IS NULL;"
    'nClosed = RecordsAffected(cn)

    'cn.Execute _
      "INSERT INTO " & T_ARC & " (Booking, [NO DOSSIER CREDIT], VG_StartDate, VG_EndDate, VG_Duree, VG_WorstInsuffisance, VG_DateWorstInsuffisance, VG_LastInsuffisance, VG_LastUpdateDate, " & _
      "Limite, Consommation, [Montant VG], [Montant AM], [Montant SL], [Production Date], [NO INTERVENANT], [NO INTERVENANT GRP], DepassementNA, FlagVG, FlagAM, FlagSL) " & _
      "SELECT f.Booking, f.[NO DOSSIER CREDIT], f.VG_StartDate, t.[Production Date], f.VG_NbJoursRetard, f.VG_WorstInsuffisance, f.VG_DateWorstInsuffisance, f.VG_LastInsuffisance, f.VG_LastUpdateDate, " & _
      "f.Limite, f.Consommation, f.[Montant VG], f.[Montant AM], f.[Montant SL], t.[Production Date], f.[NO INTERVENANT], f.[NO INTERVENANT GRP], f.DepassementNA, 'YES','NO','NO' " & _
      "FROM " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "WHERE f.VG_StartDate IS NOT NULL AND t.[Insuffisance VG] >= 0;"
    'nClosed = nClosed + RecordsAffected(cn)

    'AM
    'cn.Execute _
      "INSERT INTO " & T_ARC & " (Booking, [NO DOSSIER CREDIT], AM_StartDate, AM_EndDate, AM_Duree, AM_WorstInsuffisance, AM_DateWorstInsuffisance, AM_LastInsuffisance, AM_LastUpdateDate, " & _
      "Limite, Consommation, [Montant VG], [Montant AM], [Montant SL], [Production Date], [NO INTERVENANT], [NO INTERVENANT GRP], DepassementNA, FlagVG, FlagAM, FlagSL) " & _
      "SELECT f.Booking, f.[NO DOSSIER CREDIT], f.AM_StartDate, f.AM_LastUpdateDate, f.AM_NbJoursRetard, f.AM_WorstInsuffisance, f.AM_DateWorstInsuffisance, f.AM_LastInsuffisance, f.AM_LastUpdateDate, " & _
      "f.Limite, f.Consommation, f.[Montant VG], f.[Montant AM], f.[Montant SL], f.[Production Date], f.[NO INTERVENANT], f.[NO INTERVENANT GRP], f.DepassementNA, 'NO','YES','NO' " & _
      "FROM " & T_FLUX & " AS f LEFT JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "WHERE f.AM_StartDate IS NOT NULL AND t.Booking IS NULL;"
    'nClosed = nClosed + RecordsAffected(cn)

    'cn.Execute _
      "INSERT INTO " & T_ARC & " (Booking, [NO DOSSIER CREDIT], AM_StartDate, AM_EndDate, AM_Duree, AM_WorstInsuffisance, AM_DateWorstInsuffisance, AM_LastInsuffisance, AM_LastUpdateDate, " & _
      "Limite, Consommation, [Montant VG], [Montant AM], [Montant SL], [Production Date], [NO INTERVENANT], [NO INTERVENANT GRP], DepassementNA, FlagVG, FlagAM, FlagSL) " & _
      "SELECT f.Booking, f.[NO DOSSIER CREDIT], f.AM_StartDate, t.[Production Date], f.AM_NbJoursRetard, f.AM_WorstInsuffisance, f.AM_DateWorstInsuffisance, f.AM_LastInsuffisance, f.AM_LastUpdateDate, " & _
      "f.Limite, f.Consommation, f.[Montant VG], f.[Montant AM], f.[Montant SL], t.[Production Date], f.[NO INTERVENANT], f.[NO INTERVENANT GRP], f.DepassementNA, 'NO','YES','NO' " & _
      "FROM " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "WHERE f.AM_StartDate IS NOT NULL AND t.[Insuffisance AM] >= 0;"
    'nClosed = nClosed + RecordsAffected(cn)

    'SL
    'cn.Execute _
      "INSERT INTO " & T_ARC & " (Booking, [NO DOSSIER CREDIT], SL_StartDate, SL_EndDate, SL_Duree, SL_WorstInsuffisance, SL_DateWorstInsuffisance, SL_LastInsuffisance, SL_LastUpdateDate, " & _
      "Limite, Consommation, [Montant VG], [Montant AM], [Montant SL], [Production Date], [NO INTERVENANT], [NO INTERVENANT GRP], DepassementNA, FlagVG, FlagAM, FlagSL) " & _
      "SELECT f.Booking, f.[NO DOSSIER CREDIT], f.SL_StartDate, f.SL_LastUpdateDate, f.SL_NbJoursRetard, f.SL_WorstInsuffisance, f.SL_DateWorstInsuffisance, f.SL_LastInsuffisance, f.SL_LastUpdateDate, " & _
      "f.Limite, f.Consommation, f.[Montant VG], f.[Montant AM], f.[Montant SL], f.[Production Date], f.[NO INTERVENANT], f.[NO INTERVENANT GRP], f.DepassementNA, 'NO','NO','YES' " & _
      "FROM " & T_FLUX & " AS f LEFT JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "WHERE f.SL_StartDate IS NOT NULL AND t.Booking IS NULL;"
    'nClosed = nClosed + RecordsAffected(cn)

    'cn.Execute _
      "INSERT INTO " & T_ARC & " (Booking, [NO DOSSIER CREDIT], SL_StartDate, SL_EndDate, SL_Duree, SL_WorstInsuffisance, SL_DateWorstInsuffisance, SL_LastInsuffisance, SL_LastUpdateDate, " & _
      "Limite, Consommation, [Montant VG], [Montant AM], [Montant SL], [Production Date], [NO INTERVENANT], [NO INTERVENANT GRP], DepassementNA, FlagVG, FlagAM, FlagSL) " & _
      "SELECT f.Booking, f.[NO DOSSIER CREDIT], f.SL_StartDate, t.[Production Date], f.SL_NbJoursRetard, f.SL_WorstInsuffisance, f.SL_DateWorstInsuffisance, f.SL_LastInsuffisance, f.SL_LastUpdateDate, " & _
      "f.Limite, f.Consommation, f.[Montant VG], f.[Montant AM], f.[Montant SL], t.[Production Date], f.[NO INTERVENANT], f.[NO INTERVENANT GRP], f.DepassementNA, 'NO','NO','YES' " & _
      "FROM " & T_FLUX & " AS f INNER JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "WHERE f.SL_StartDate IS NOT NULL AND t.[Insuffisance SL] >= 0;"
    'nClosed = nClosed + RecordsAffected(cn)

    '7) Flags multi-natures via historique (passe à 'YES' si chevauchement avec insuff < 0)
    'cn.Execute _
      "UPDATE " & T_ARC & " AS a SET a.FlagAM='YES' " & _
      "WHERE a.FlagVG='YES' AND EXISTS (" & _
      "  SELECT 1 FROM " & T_HIST & " h " & _
      "  WHERE h.Booking=a.Booking AND h.[NO DOSSIER CREDIT]=a.[NO DOSSIER CREDIT] AND h.Nature='AM' " & _
      "    AND h.[Production Date] BETWEEN a.VG_StartDate AND a.VG_EndDate AND h.Insuffisance < 0" & _
      ");"
    'cn.Execute _
      "UPDATE " & T_ARC & " AS a SET a.FlagSL='YES' " & _
      "WHERE a.FlagVG='YES' AND EXISTS (" & _
      "  SELECT 1 FROM " & T_HIST & " h " & _
      "  WHERE h.Booking=a.Booking AND h.[NO DOSSIER CREDIT]=a.[NO DOSSIER CREDIT] AND h.Nature='SL' " & _
      "    AND h.[Production Date] BETWEEN a.VG_StartDate AND a.VG_EndDate AND h.Insuffisance < 0" & _
      ");"

    'cn.Execute _
      "UPDATE " & T_ARC & " AS a SET a.FlagVG='YES' " & _
      "WHERE a.FlagAM='YES' AND EXISTS (" & _
      "  SELECT 1 FROM " & T_HIST & " h " & _
      "  WHERE h.Booking=a.Booking AND h.[NO DOSSIER CREDIT]=a.[NO DOSSIER CREDIT] AND h.Nature='VG' " & _
      "    AND h.[Production Date] BETWEEN a.AM_StartDate AND a.AM_EndDate AND h.Insuffisance < 0" & _
      ");"
    'cn.Execute _
      "UPDATE " & T_ARC & " AS a SET a.FlagSL='YES' " & _
      "WHERE a.FlagAM='YES' AND EXISTS (" & _
      "  SELECT 1 FROM " & T_HIST & " h " & _
      "  WHERE h.Booking=a.Booking AND h.[NO DOSSIER CREDIT]=a.[NO DOSSIER CREDIT] AND h.Nature='SL' " & _
      "    AND h.[Production Date] BETWEEN a.AM_StartDate AND a.AM_EndDate AND h.Insuffisance < 0" & _
      ");"

    'cn.Execute _
      "UPDATE " & T_ARC & " AS a SET a.FlagVG='YES' " & _
      "WHERE a.FlagSL='YES' AND EXISTS (" & _
      "  SELECT 1 FROM " & T_HIST & " h " & _
      "  WHERE h.Booking=a.Booking AND h.[NO DOSSIER CREDIT]=a.[NO DOSSIER CREDIT] AND h.Nature='VG' " & _
      "    AND h.[Production Date] BETWEEN a.SL_StartDate AND a.SL_EndDate AND h.Insuffisance < 0" & _
      ");"
    'cn.Execute _
      "UPDATE " & T_ARC & " AS a SET a.FlagAM='YES' " & _
      "WHERE a.FlagSL='YES' AND EXISTS (" & _
      "  SELECT 1 FROM " & T_HIST & " h " & _
      "  WHERE h.Booking=a.Booking AND h.[NO DOSSIER CREDIT]=a.[NO DOSSIER CREDIT] AND h.Nature='AM' " & _
      "    AND h.[Production Date] BETWEEN a.SL_StartDate AND a.SL_EndDate AND h.Insuffisance < 0" & _
      ");"

    '8) Purge FLUX des sous-épisodes clos
    cn.Execute _
      "UPDATE " & T_FLUX & " AS f LEFT JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.VG_StartDate=Null, f.VG_LastUpdateDate=Null, f.VG_NbJoursRetard=Null, f.VG_WorstInsuffisance=Null, f.VG_DateWorstInsuffisance=Null, f.VG_LastInsuffisance=Null, f.VG_EndDate=Null " & _
      "WHERE f.VG_StartDate IS NOT NULL AND (t.Booking IS NULL OR t.[Insuffisance VG] >= 0);"
    cn.Execute _
      "UPDATE " & T_FLUX & " AS f LEFT JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.AM_StartDate=Null, f.AM_LastUpdateDate=Null, f.AM_NbJoursRetard=Null, f.AM_WorstInsuffisance=Null, f.AM_DateWorstInsuffisance=Null, f.AM_LastInsuffisance=Null, f.AM_EndDate=Null " & _
      "WHERE f.AM_StartDate IS NOT NULL AND (t.Booking IS NULL OR t.[Insuffisance AM] >= 0);"
    cn.Execute _
      "UPDATE " & T_FLUX & " AS f LEFT JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET f.SL_StartDate=Null, f.SL_LastUpdateDate=Null, f.SL_NbJoursRetard=Null, f.SL_WorstInsuffisance=Null, f.SL_DateWorstInsuffisance=Null, f.SL_LastInsuffisance=Null, f.SL_EndDate=Null " & _
      "WHERE f.SL_StartDate IS NOT NULL AND (t.Booking IS NULL OR t.[Insuffisance SL] >= 0);"

    'Supprime la ligne si plus aucun sous-épisode ouvert
    cn.Execute "DELETE FROM " & T_FLUX & " WHERE VG_StartDate IS NULL AND AM_StartDate IS NULL AND SL_StartDate IS NULL;"

    cn.CommitTrans
    newFlux = nNew: contFlux = nCont: closedFlux = nClosed
    Exit Sub
ROLLBACK:
    cn.RollbackTrans
    cn.Close: Set cn = Nothing
    Err.Raise Err.Number, , Err.description
End Sub

' ====== Enrichissement feuille ======
Private Sub EnrichSheetFromFlux_3in1(ByVal cn As ADODB.Connection, ByVal ws As Worksheet)

    Dim prodDateSheet   As Variant, dVG As Dictionary, dAM As Dictionary, dSL As Dictionary
    Dim aVG             As Dictionary, aAM As Dictionary, aSL As Dictionary, map As New Dictionary
    Dim cNBJ_VG         As Long, cDEB_VG As Long, cFIN_VG As Long, cNBJ_AM As Long, cDEB_AM As Long, cFIN_AM As Long
    Dim cNBJ_SL         As Long, cDEB_SL As Long, cFIN_SL As Long, cNA As Long, r As Long, lastRow As Long
    Dim bk              As String, dos As String, k As String, conso As Double, lim As Double
    
    cNBJ_VG = EnsureColumn(ws, COL_NBJ_VG): cDEB_VG = EnsureColumn(ws, COL_DEB_VG): cFIN_VG = EnsureColumn(ws, COL_FIN_VG)
    cNBJ_AM = EnsureColumn(ws, COL_NBJ_AM): cDEB_AM = EnsureColumn(ws, COL_DEB_AM): cFIN_AM = EnsureColumn(ws, COL_FIN_AM)
    cNBJ_SL = EnsureColumn(ws, COL_NBJ_SL): cDEB_SL = EnsureColumn(ws, COL_DEB_SL): cFIN_SL = EnsureColumn(ws, COL_FIN_SL)
    cNA = EnsureColumn(ws, COL_FLAG_NA)

    prodDateSheet = DetectSheetProductionDate(ws)

    Set dVG = LoadFluxDict_3in1(cn, "VG")
    Set dAM = LoadFluxDict_3in1(cn, "AM")
    Set dSL = LoadFluxDict_3in1(cn, "SL")

    Set aVG = LoadArchiveEndDictForDate_3in1(cn, "VG", prodDateSheet)
    Set aAM = LoadArchiveEndDictForDate_3in1(cn, "AM", prodDateSheet)
    Set aSL = LoadArchiveEndDictForDate_3in1(cn, "SL", prodDateSheet)

    Call MapCol(map, ws, COL_BOOKING)
    Call MapCol(map, ws, COL_DOSSIER)
    Call MapCol(map, ws, COL_CONSO)
    Call MapCol(map, ws, COL_LIMITE)

    lastRow = ws.Cells(ws.rows.count, 1).End(xlUp).row
    If lastRow < 2 Then Exit Sub

    For r = 2 To lastRow
    
        bk = Trim$(UCase$(CStr(ws.Cells(r, map(COL_BOOKING)).Value)))
        dos = Trim$(CStr(ws.Cells(r, map(COL_DOSSIER)).Value))
        k = bk & "||" & dos

        conso = val(ws.Cells(r, map(COL_CONSO)).Value)
        lim = val(ws.Cells(r, map(COL_LIMITE)).Value)
        If Abs(conso) > lim Then
            ws.Cells(r, cNA).Value = "YES"
        Else
            ws.Cells(r, cNA).Value = "NO"
        End If

        If dVG.exists(k) Then
            ws.Cells(r, cNBJ_VG).Value = dVG(k)(1)
            ws.Cells(r, cDEB_VG).Value = dVG(k)(0)
        Else
            ws.Cells(r, cNBJ_VG).ClearContents
            ws.Cells(r, cDEB_VG).ClearContents
        End If
        If aVG.exists(k) Then ws.Cells(r, cFIN_VG).Value = aVG(k) Else ws.Cells(r, cFIN_VG).ClearContents

        If dAM.exists(k) Then
            ws.Cells(r, cNBJ_AM).Value = dAM(k)(1)
            ws.Cells(r, cDEB_AM).Value = dAM(k)(0)
        Else
            ws.Cells(r, cNBJ_AM).ClearContents
            ws.Cells(r, cDEB_AM).ClearContents
        End If
        If aAM.exists(k) Then ws.Cells(r, cFIN_AM).Value = aAM(k) Else ws.Cells(r, cFIN_AM).ClearContents

        If dSL.exists(k) Then
            ws.Cells(r, cNBJ_SL).Value = dSL(k)(1)
            ws.Cells(r, cDEB_SL).Value = dSL(k)(0)
        Else
            ws.Cells(r, cNBJ_SL).ClearContents
            ws.Cells(r, cDEB_SL).ClearContents
        End If
        If aSL.exists(k) Then ws.Cells(r, cFIN_SL).Value = aSL(k) Else ws.Cells(r, cFIN_SL).ClearContents
    Next r

    ws.Columns(cNBJ_VG).NumberFormat = "0"
    ws.Columns(cNBJ_AM).NumberFormat = "0"
    ws.Columns(cNBJ_SL).NumberFormat = "0"
    ws.Columns(cDEB_VG).NumberFormat = "dd/mm/yyyy"
    ws.Columns(cDEB_AM).NumberFormat = "dd/mm/yyyy"
    ws.Columns(cDEB_SL).NumberFormat = "dd/mm/yyyy"
    ws.Columns(cFIN_VG).NumberFormat = "dd/mm/yyyy"
    ws.Columns(cFIN_AM).NumberFormat = "dd/mm/yyyy"
    ws.Columns(cFIN_SL).NumberFormat = "dd/mm/yyyy"
    
End Sub

' ====== Helpers ======
Private Function DetectSheetProductionDate(ws As Worksheet) As Variant

    Dim col As Long, lastRow As Long, r As Long, maxDt As Date
    
    col = FindHeader(ws, COL_PROD)
    
    If col = 0 Then DetectSheetProductionDate = Date: Exit Function
    lastRow = ws.Cells(ws.rows.count, col).End(xlUp).row
    maxDt = #1/1/1900#
    For r = 2 To lastRow
        If IsDate(ws.Cells(r, col).Value) Then
            If CDate(ws.Cells(r, col).Value) > maxDt Then maxDt = CDate(ws.Cells(r, col).Value)
        End If
    Next r
    If maxDt = #1/1/1900# Then DetectSheetProductionDate = Date Else DetectSheetProductionDate = maxDt
    
End Function

Private Function LoadFluxDict_3in1(ByVal cn As ADODB.Connection, ByVal nature As String) As Dictionary

    Dim d As New Dictionary, rs As Object, sql As String
    
    Set rs = CreateObject("ADODB.Recordset")
    
    If nature = "VG" Then
        sql = "SELECT Booking, [NO DOSSIER CREDIT], VG_StartDate, VG_NbJoursRetard FROM " & T_FLUX & " WHERE VG_StartDate IS NOT NULL"
    ElseIf nature = "AM" Then
        sql = "SELECT Booking, [NO DOSSIER CREDIT], AM_StartDate, AM_NbJoursRetard FROM " & T_FLUX & " WHERE AM_StartDate IS NOT NULL"
    Else
        sql = "SELECT Booking, [NO DOSSIER CREDIT], SL_StartDate, SL_NbJoursRetard FROM " & T_FLUX & " WHERE SL_StartDate IS NOT NULL"
    End If
    rs.Open sql, cn, 1, 1
    Do While Not rs.EOF
        d(Trim$(UCase$(rs(0).Value)) & "||" & Trim$(rs(1).Value)) = Array(rs(2).Value, rs(3).Value)
        rs.MoveNext
    Loop
    Set LoadFluxDict_3in1 = d
    
End Function

Private Function LoadArchiveEndDictForDate_3in1(ByVal cn As ADODB.Connection, ByVal nature As String, ByVal endDate As Variant) As Dictionary

    Dim d As New Dictionary, rs As Object, sql As String, dStr As String
    
    If IsDate(endDate) = False Then Set LoadArchiveEndDictForDate_3in1 = d: Exit Function

    Set rs = CreateObject("ADODB.Recordset")
    
    dStr = Format(CDate(endDate), "mm/dd/yyyy")
    If nature = "VG" Then
        sql = "SELECT Booking, [NO DOSSIER CREDIT], VG_EndDate FROM " & T_ARC & " WHERE FlagVG='YES' AND VG_EndDate = #" & dStr & "#"
    ElseIf nature = "AM" Then
        sql = "SELECT Booking, [NO DOSSIER CREDIT], AM_EndDate FROM " & T_ARC & " WHERE FlagAM='YES' AND AM_EndDate = #" & dStr & "#"
    Else
        sql = "SELECT Booking, [NO DOSSIER CREDIT], SL_EndDate FROM " & T_ARC & " WHERE FlagSL='YES' AND SL_EndDate = #" & dStr & "#"
    End If
    rs.Open sql, cn, 1, 1
    Do While Not rs.EOF
        d(Trim$(UCase$(rs(0).Value)) & "||" & Trim$(rs(1).Value)) = rs(2).Value
        rs.MoveNext
    Loop
    Set LoadArchiveEndDictForDate_3in1 = d
    
End Function

Sub MapCol(ByVal dict As Object, ByVal ws As Worksheet, ByVal name1 As String, Optional ByVal name2 As String = "")

    Dim c As Long
    c = FindHeader(ws, name1)
    If c = 0 And Len(name2) > 0 Then c = FindHeader(ws, name2)
    If c = 0 Then Err.Raise vbObjectError + 10, , "Colonne introuvable : " & name1 & IIf(Len(name2) > 0, " (alt : " & name2 & ")", "")
    dict(AddKey(dict, name1)) = c
    
End Sub

Private Function AddKey(ByVal dict As Object, ByVal k As String) As String
    If Not dict.exists(k) Then dict.Add k, 0
    AddKey = k
End Function

Private Function FindHeader(ByVal ws As Worksheet, ByVal hdr As String) As Long
    Dim c As Range
    For Each c In ws.rows(1).Cells
        If Trim$(UCase$(c.Value & "")) = Trim$(UCase$(hdr)) Then FindHeader = c.Column: Exit Function
        If Len(c.Value & "") = 0 Then Exit For
    Next c
End Function

Private Function GetCellMaybe(ws As Worksheet, r As Long, map As Object, name1 As String, name2 As String) As Variant
    If map.exists(name1) Then GetCellMaybe = ws.Cells(r, map(name1)).Value: Exit Function
    If map.exists(name2) Then GetCellMaybe = ws.Cells(r, map(name2)).Value: Exit Function
    GetCellMaybe = Null
End Function

Private Function EnsureColumn(ByVal ws As Worksheet, ByVal header As String) As Long

    Dim c As Long, lastCol As Long
    c = FindHeader(ws, header)
    If c > 0 Then EnsureColumn = c: Exit Function
    lastCol = ws.Cells(1, ws.Columns.count).End(xlToLeft).Column
    ws.Cells(1, lastCol + 1).Value = header
    EnsureColumn = lastCol + 1
    
End Function

Public Sub NormalizeHeadersInSheet(ByVal ws As Worksheet)
    Dim h As Range, i As Long, lastCol As Long
    lastCol = ws.Cells(1, ws.Columns.count).End(xlToLeft).Column
    For i = 1 To lastCol
        Set h = ws.Cells(1, i)
        Select Case UCase$(Trim$(h.Value & ""))
            Case "NO NTERVENANT":              h.Value = "NO INTERVENANT"
            Case "NO NTERVENANT GRP":          h.Value = "NO INTERVENANT GRP"
            Case "MONTANT VG (VALEUR DE GAGE-LTV)": h.Value = "Montant VG"
        End Select
    Next i
End Sub


' ====== Logging ======
Private Sub WriteRunLog(ByVal cn As ADODB.Connection, ByVal rowsImp As Long, ByVal newF As Long, ByVal contF As Long, ByVal closedF As Long)
    
    cn.Execute "INSERT INTO " & T_LOG & " (RunAt, RowsImported, NewFlux, Continued, Closed, [User]) VALUES (Now()," & rowsImp & "," & newF & "," & contF & "," & closedF & ",'" & Environ$("Username") & "')"
 
End Sub

'****************** CREATION TABLE IF NOT EXIST *******************************************************
Private Sub EnsureDatabaseAndSchema(ByVal cn As Object, ByVal dbPath As String)

    Dim cat As Object
    
    If Dir(dbPath, vbNormal) = vbNullString Then
        Set cat = CreateObject("ADOX.Catalog")
        cat.Create "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & dbPath
    End If
    ExecIfNotExists cn, T_FLUX, GetDDL_Flux
    ExecIfNotExists cn, T_ARC, GetDDL_Arc
    ExecIfNotExists cn, T_TODAY, GetDDL_Today
    ExecIfNotExists cn, T_HIST, GetDDL_Hist
    ExecIfNotExists cn, T_LOG, GetDDL_Log
    ExecIfNotExists cn, T_CLOSE, GetDDL_Close 'New
    
End Sub

Private Function GetDDL_Flux() As String
    GetDDL_Flux = "CREATE TABLE " & T_FLUX & " (" & _
                  "Booking TEXT(20) NOT NULL, [NO DOSSIER CREDIT] TEXT(50) NOT NULL, " & _
                  "VG_StartDate DATE, VG_LastUpdateDate DATE, VG_NbJoursRetard LONG, VG_WorstInsuffisance DOUBLE, VG_DateWorstInsuffisance DATE, VG_LastInsuffisance DOUBLE, VG_EndDate DATE, " & _
                  "AM_StartDate DATE, AM_LastUpdateDate DATE, AM_NbJoursRetard LONG, AM_WorstInsuffisance DOUBLE, AM_DateWorstInsuffisance DATE, AM_LastInsuffisance DOUBLE, AM_EndDate DATE, " & _
                  "SL_StartDate DATE, SL_LastUpdateDate DATE, SL_NbJoursRetard LONG, SL_WorstInsuffisance DOUBLE, SL_DateWorstInsuffisance DATE, SL_LastInsuffisance DOUBLE, SL_EndDate DATE, " & _
                  "Limite DOUBLE, Consommation DOUBLE, [Montant VG] DOUBLE, [Montant AM] DOUBLE, [Montant SL] DOUBLE, [Production Date] DATE, [NO INTERVENANT] TEXT(50), [NO INTERVENANT GRP] TEXT(50), " & _
                  "DepassementNA TEXT(3), " & _
                  "CONSTRAINT PK_Flux3 PRIMARY KEY (Booking, [NO DOSSIER CREDIT]) );"
End Function

Private Function GetDDL_Arc() As String
    GetDDL_Arc = "CREATE TABLE " & T_ARC & " (" & _
                 "ID COUNTER PRIMARY KEY, Booking TEXT(20) NOT NULL, [NO DOSSIER CREDIT] TEXT(50) NOT NULL, " & _
                 "VG_StartDate DATE, VG_EndDate DATE, VG_Duree LONG, VG_WorstInsuffisance DOUBLE, VG_DateWorstInsuffisance DATE, VG_LastInsuffisance DOUBLE, VG_LastUpdateDate DATE, " & _
                 "AM_StartDate DATE, AM_EndDate DATE, AM_Duree LONG, AM_WorstInsuffisance DOUBLE, AM_DateWorstInsuffisance DATE, AM_LastInsuffisance DOUBLE, AM_LastUpdateDate DATE, " & _
                 "SL_StartDate DATE, SL_EndDate DATE, SL_Duree LONG, SL_WorstInsuffisance DOUBLE, SL_DateWorstInsuffisance DATE, SL_LastInsuffisance DOUBLE, SL_LastUpdateDate DATE, " & _
                 "Limite DOUBLE, Consommation DOUBLE, [Montant VG] DOUBLE, [Montant AM] DOUBLE, [Montant SL] DOUBLE, [Production Date] DATE, [NO INTERVENANT] TEXT(50), [NO INTERVENANT GRP] TEXT(50), " & _
                 "DepassementNA TEXT(3), FlagVG TEXT(3), FlagAM TEXT(3), FlagSL TEXT(3), ArchivedAt DATE);"
End Function


Private Function GetDDL_Today() As String
    GetDDL_Today = "CREATE TABLE " & T_TODAY & " (" & _
                   "Booking TEXT(20), [Production Date] DATE, [NO DOSSIER CREDIT] TEXT(50), " & _
                   "[NO INTERVENANT] TEXT(50), [NO INTERVENANT GRP] TEXT(50), " & _
                   "Limite DOUBLE, Consommation DOUBLE, [Montant VG] DOUBLE, [Montant AM] DOUBLE, [Montant SL] DOUBLE, " & _
                   "[Insuffisance VG] DOUBLE, [Insuffisance AM] DOUBLE, [Insuffisance SL] DOUBLE);"
End Function

Private Function GetDDL_Hist() As String
    GetDDL_Hist = _
      "CREATE TABLE " & T_HIST & " (" & _
      "Booking TEXT(20) NOT NULL, [NO DOSSIER CREDIT] TEXT(50) NOT NULL, Nature TEXT(2) NOT NULL, [Production Date] DATE NOT NULL, " & _
      "Insuffisance DOUBLE, Consommation DOUBLE, Limite DOUBLE, [Montant] DOUBLE, DepassementNA TEXT(3) DEFAULT 'NO', " & _
      "CONSTRAINT IX_Hist UNIQUE (Booking, [NO DOSSIER CREDIT], Nature, [Production Date]) );"
End Function

Private Function GetDDL_Log() As String

    GetDDL_Log = _
      "CREATE TABLE " & T_LOG & " (" & _
      "RunAt DATETIME NOT NULL, RowsImported LONG, NewFlux LONG, Continued LONG, Closed LONG, [User] TEXT(100));"
      
End Function

Private Function GetDDL_Close() As String

    GetDDL_Close = _
      "CREATE TABLE " & T_CLOSE & " (" & _
      "  Booking TEXT(20) NOT NULL, [NO DOSSIER CREDIT] TEXT(50) NOT NULL, " & _
      "  VG_StartDate DATE, VG_EndDate DATE, VG_Duree LONG, VG_WorstInsuffisance DOUBLE, VG_DateWorstInsuffisance DATE, VG_LastInsuffisance DOUBLE, VG_LastUpdateDate DATE, " & _
      "  AM_StartDate DATE, AM_EndDate DATE, AM_Duree LONG, AM_WorstInsuffisance DOUBLE, AM_DateWorstInsuffisance DATE, AM_LastInsuffisance DOUBLE, AM_LastUpdateDate DATE, " & _
      "  SL_StartDate DATE, SL_EndDate DATE, SL_Duree LONG, SL_WorstInsuffisance DOUBLE, SL_DateWorstInsuffisance DATE, SL_LastInsuffisance DOUBLE, SL_LastUpdateDate DATE, " & _
      "  Limite DOUBLE, Consommation DOUBLE, [Montant VG] DOUBLE, [Montant AM] DOUBLE, [Montant SL] DOUBLE, " & _
      "  [Production Date] DATE, [NO INTERVENANT] TEXT(50), [NO INTERVENANT GRP] TEXT(50), " & _
      "  DepassementNA TEXT(3) DEFAULT 'NO', " & _
      "  FlagVG TEXT(3) , FlagAM TEXT(3) , FlagSL TEXT(3) , " & _
      "  CONSTRAINT PK_CloseBuf PRIMARY KEY (Booking, [NO DOSSIER CREDIT])" & _
      ");"
      
End Function

Private Function RecordsAffected(ByVal cn As Object) As Long

    On Error Resume Next
    RecordsAffected = cn.RecordsAffected
    
End Function

Private Sub ExecIfNotExists(ByVal cn As Object, ByVal tableName As String, ByVal ddl As String)

    Dim rs As Object, exists As Boolean
    Set rs = cn.OpenSchema(20) ' adSchemaTables
    exists = False
    Do While Not rs.EOF
        If StrComp(rs.Fields("TABLE_NAME").Value & "", tableName, vbTextCompare) = 0 Then exists = True: Exit Do
        rs.MoveNext
    Loop
    rs.Close
    Set rs = Nothing
    If Not exists Then cn.Execute ddl
    
End Sub

'******************************************** CHECK INDEX
Sub CreateIndexesIfNotExists()

    Dim dbPath As String
    dbPath = ThisWorkbook.Path & Application.PathSeparator & DB_NAME
    EnsureIndexes dbPath
    MsgBox "Les index ont été vérifiés et créés si nécessaire.", vbInformation
    
End Sub

Private Sub EnsureIndexes(ByVal cn As ADODB.Connection)

    Dim rs As Object, indexName As Variant, indexes As New Dictionary, sql As String, tableName As String, IndexExists As Boolean

    'Connexion à la base de données
    Set cn = GetConn(dbPath)

    'Index pour T_ARC
    indexes.Add "IX_Arc3_Key", "CREATE INDEX IX_Arc3_Key ON " & T_ARC & " (Booking, [NO DOSSIER CREDIT])"
    indexes.Add "IX_Arc3_VG_End", "CREATE INDEX IX_Arc3_VG_End ON " & T_ARC & " (VG_EndDate)"
    indexes.Add "IX_Arc3_AM_End", "CREATE INDEX IX_Arc3_AM_End ON " & T_ARC & " (AM_EndDate)"
    indexes.Add "IX_Arc3_SL_End", "CREATE INDEX IX_Arc3_SL_End ON " & T_ARC & " (SL_EndDate)"
    
    'Index pour T_TODAY
    indexes.Add "IX_Today_Key", "CREATE INDEX IX_Today_Key ON " & T_TODAY & " (Booking, [NO DOSSIER CREDIT])"
    
    'Index pour T_FLUX
    indexes.Add "IX_Flux3_VG_Start", "CREATE INDEX IX_Flux3_VG_Start ON " & T_FLUX & " (VG_StartDate)"
    indexes.Add "IX_Flux3_AM_Start", "CREATE INDEX IX_Flux3_AM_Start ON " & T_FLUX & " (AM_StartDate)"
    indexes.Add "IX_Flux3_SL_Start", "CREATE INDEX IX_Flux3_SL_Start ON " & T_FLUX & " (SL_StartDate)"

    'Parcourir chaque index et vérifier s'il existe
    For Each indexName In indexes.keys
        If Not FctIndexExists(cn, CStr(indexName)) Then
            sql = indexes(indexName)
            cn.Execute sql
            Debug.Print "Index créé : " & indexName
        Else
            Debug.Print "Index déjà existant : " & indexName
        End If
    Next indexName
    'Libérer les objets
    Set indexes = Nothing
    
End Sub

'Fonction pour vérifier si un index existe déjà
Private Function FctIndexExists(ByVal cn As Object, ByVal indexName As String) As Boolean

    Dim rs As Object, exists As Boolean
    
    exists = False
    'Ouvrir le schéma des index
    Set rs = cn.OpenSchema(12) 'adSchemaIndexes
    Do While Not rs.EOF
        If StrComp(rs.Fields("INDEX_NAME").Value & "", indexName, vbTextCompare) = 0 Then
            exists = True
            Exit Do
        End If
        rs.MoveNext
    Loop
    rs.Close
    Set rs = Nothing
    FctIndexExists = exists
    
End Function

' ************************************************ TEST
'Date -> littéral SQL (#mm/dd/yyyy#)
Private Function SqlDate(ByVal d As Date) As String
    SqlDate = "#" & Format$(d, "mm\/dd\/yyyy") & "#"
End Function

Private Sub EnsureConfigTable(ByVal cn As ADODB.Connection)

    On Error GoTo Fallback
    ExecIfNotExists cn, T_CFG, _
        "CREATE TABLE " & T_CFG & " (" & _
        "  CfgKey TEXT(50) NOT NULL," & _
        "  CfgVal TEXT(255)," & _
        "  CONSTRAINT PK_" & T_CFG & " PRIMARY KEY (CfgKey)" & _
        ")"
    Exit Sub
Fallback:
    On Error Resume Next
    ExecIfNotExists cn, T_CFG, _
        "CREATE TABLE " & T_CFG & " (" & _
        "  CfgKey TEXT(50) NOT NULL," & _
        "  CfgVal TEXT(255)" & _
        ")"
    ' clé primaire via index (syntaxe Access)
    cn.Execute "CREATE UNIQUE INDEX PK_" & T_CFG & " ON " & T_CFG & " (CfgKey) WITH PRIMARY;"
    On Error GoTo 0
    
End Sub

'Lit une clé de config (ou renvoie "")
Private Function CfgGet(ByVal cn As Object, ByVal k As String, Optional ByVal defaultVal As String = "") As String

    Dim rs As Object, sK As String
    sK = Replace(k, "'", "''")
    Set rs = CreateObject("ADODB.Recordset")
    rs.Open "SELECT CfgVal FROM " & T_CFG & " WHERE CfgKey='" & sK & "'", cn, 1, 1
    If Not (rs.EOF Or rs.BOF) Then
        CfgGet = rs.Fields(0).Value & ""
    Else
        CfgGet = defaultVal
    End If
    rs.Close: Set rs = Nothing
    
End Function

'Upsert "clé ? valeur"
Private Sub CfgSet(ByVal cn As Object, ByVal k As String, ByVal v As String)
    Dim sK As String, sV As String, n As Long
    sK = Replace(k, "'", "''")
    sV = Replace(v, "'", "''")
    cn.Execute "UPDATE " & T_CFG & " SET CfgVal='" & sV & "' WHERE CfgKey='" & sK & "'", n
    If n = 0 Then
        cn.Execute "INSERT INTO " & T_CFG & " (CfgKey, CfgVal) VALUES ('" & sK & "','" & sV & "')"
    End If
End Sub

'Renvoie la date simulée (créée si absente)
Private Function GetSimDate(ByVal cn As ADODB.Connection) As Date

    Dim s As String
    
    Call EnsureConfigTable(cn)
    
    s = CfgGet(cn, "SimDate")
    
    If Len(s) = 0 Then
        CfgSet cn, "SimDate", Format$(TEST_START_DATE, "yyyy-mm-dd")
        GetSimDate = TEST_START_DATE
    Else
        ' parse "yyyy-mm-dd" en Date
        GetSimDate = DateSerial(Left$(s, 4), Mid$(s, 6, 2), Right$(s, 2))
    End If

End Function

'Avance la date simulée de TEST_STEP_DAYS
Private Sub BumpSimDate(ByVal cn As ADODB.Connection)

    Dim d As Date
    
    EnsureConfigTable cn
    d = GetSimDate(cn)
    d = DateAdd("d", TEST_STEP_DAYS, d)
    CfgSet cn, "SimDate", Format$(d, "yyyy-mm-dd")
      
End Sub

'Utilitaire pour forcer une date simulée manuellement (ex. tests)
Private Sub SetSimDateManual()

    Dim dbPath As String, s As String, d As Date
    
    dbPath = ThisWorkbook.Path & Application.PathSeparator & DB_NAME
    s = InputBox("Entrer la date simulée (yyyy-mm-dd)", "Set SimDate", "2024-01-01")
    If Len(s) = 10 Then
        On Error Resume Next
        d = DateSerial(Left$(s, 4), Mid$(s, 6, 2), Right$(s, 2))
        On Error GoTo 0
        If d > 0 Then
            Dim cn As Object: Set cn = GetConn(dbPath)
            EnsureConfigTable cn
            CfgSet cn, "SimDate", Format$(d, "yyyy-mm-dd")
            cn.Close: Set cn = Nothing
            MsgBox "SimDate = " & Format$(d, "yyyy-mm-dd"), vbInformation
        Else
            MsgBox "Date invalide.", vbCritical
        End If
    End If
    
End Sub

Private Sub ShowSimDate()

    Dim dbPath As String, d As Date
    dbPath = ThisWorkbook.Path & Application.PathSeparator & DB_NAME
    d = GetSimDate(dbPath)
    MsgBox "SimDate actuelle = " & Format$(d, "yyyy-mm-dd"), vbInformation
    
End Sub

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX CLOSE BUFFER ARCHIVE
Private Sub BuildCloseBuffer(ByVal cn As Object)

    'Vide le buffer
    cn.Execute "DELETE FROM " & T_CLOSE
    
    ' === 1) Clés à clôturer si AU MOINS une nature se ferme aujourd’hui ===
    cn.Execute _
      "INSERT INTO " & T_CLOSE & " (Booking, [NO DOSSIER CREDIT]) " & _
      "SELECT DISTINCT f.Booking, f.[NO DOSSIER CREDIT] " & _
      "FROM " & T_FLUX & " AS f " & _
      "LEFT JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "WHERE (f.VG_StartDate IS NOT NULL AND (t.Booking IS NULL OR t.[Insuffisance VG] >= 0)) " & _
      "   OR (f.AM_StartDate IS NOT NULL AND (t.Booking IS NULL OR t.[Insuffisance AM] >= 0)) " & _
      "   OR (f.SL_StartDate IS NOT NULL AND (t.Booking IS NULL OR t.[Insuffisance SL] >= 0));"
    
    ' === 2) Renseigne les blocs de clôture par nature ===
    ' --- VG ---
    cn.Execute _
      "UPDATE (" & T_CLOSE & " b INNER JOIN " & T_FLUX & " f ON b.Booking=f.Booking AND b.[NO DOSSIER CREDIT]=f.[NO DOSSIER CREDIT]) " & _
      "LEFT JOIN " & T_TODAY & " t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET b.VG_StartDate=f.VG_StartDate, b.VG_Duree=f.VG_NbJoursRetard, " & _
      "    b.VG_WorstInsuffisance=f.VG_WorstInsuffisance, b.VG_DateWorstInsuffisance=f.VG_DateWorstInsuffisance, " & _
      "    b.VG_LastInsuffisance=f.VG_LastInsuffisance, b.VG_LastUpdateDate=f.VG_LastUpdateDate, b.FlagVG='YES', " & _
      "    b.VG_EndDate=IIf(t.Booking Is Null, f.VG_LastUpdateDate, t.[Production Date]) " & _
      "WHERE f.VG_StartDate IS NOT NULL AND (t.Booking IS NULL OR t.[Insuffisance VG] >= 0);"
    
    ' --- AM ---
    cn.Execute _
      "UPDATE (" & T_CLOSE & " b INNER JOIN " & T_FLUX & " f ON b.Booking=f.Booking AND b.[NO DOSSIER CREDIT]=f.[NO DOSSIER CREDIT]) " & _
      "LEFT JOIN " & T_TODAY & " t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET b.AM_StartDate=f.AM_StartDate, b.AM_Duree=f.AM_NbJoursRetard, " & _
      "    b.AM_WorstInsuffisance=f.AM_WorstInsuffisance, b.AM_DateWorstInsuffisance=f.AM_DateWorstInsuffisance, " & _
      "    b.AM_LastInsuffisance=f.AM_LastInsuffisance, b.AM_LastUpdateDate=f.AM_LastUpdateDate, b.FlagAM='YES', " & _
      "    b.AM_EndDate=IIf(t.Booking Is Null, f.AM_LastUpdateDate, t.[Production Date]) " & _
      "WHERE f.AM_StartDate IS NOT NULL AND (t.Booking IS NULL OR t.[Insuffisance AM] >= 0);"
    
    ' --- SL ---
    cn.Execute _
      "UPDATE (" & T_CLOSE & " b INNER JOIN " & T_FLUX & " f ON b.Booking=f.Booking AND b.[NO DOSSIER CREDIT]=f.[NO DOSSIER CREDIT]) " & _
      "LEFT JOIN " & T_TODAY & " t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET b.SL_StartDate=f.SL_StartDate, b.SL_Duree=f.SL_NbJoursRetard, " & _
      "    b.SL_WorstInsuffisance=f.SL_WorstInsuffisance, b.SL_DateWorstInsuffisance=f.SL_DateWorstInsuffisance, " & _
      "    b.SL_LastInsuffisance=f.SL_LastInsuffisance, b.SL_LastUpdateDate=f.SL_LastUpdateDate, b.FlagSL='YES', " & _
      "    b.SL_EndDate=IIf(t.Booking Is Null, f.SL_LastUpdateDate, t.[Production Date]) " & _
      "WHERE f.SL_StartDate IS NOT NULL AND (t.Booking IS NULL OR t.[Insuffisance SL] >= 0);"
    
    ' === 3) Champs communs (Today si présent, sinon Flux) — sans Nz ===
    cn.Execute _
      "UPDATE (" & T_CLOSE & " b INNER JOIN " & T_FLUX & " f ON b.Booking=f.Booking AND b.[NO DOSSIER CREDIT]=f.[NO DOSSIER CREDIT]) " & _
      "LEFT JOIN " & T_TODAY & " t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET b.Limite = IIf(t.Limite Is Null, f.Limite, t.Limite), " & _
      "    b.Consommation = IIf(t.Consommation Is Null, f.Consommation, t.Consommation), " & _
      "    b.[Montant VG] = IIf(t.[Montant VG] Is Null, f.[Montant VG], t.[Montant VG]), " & _
      "    b.[Montant AM] = IIf(t.[Montant AM] Is Null, f.[Montant AM], t.[Montant AM]), " & _
      "    b.[Montant SL] = IIf(t.[Montant SL] Is Null, f.[Montant SL], t.[Montant SL]), " & _
      "    b.[Production Date] = IIf(t.[Production Date] Is Null, f.[Production Date], t.[Production Date]), " & _
      "    b.[NO INTERVENANT] = IIf(t.[NO INTERVENANT] Is Null, f.[NO INTERVENANT], t.[NO INTERVENANT]), " & _
      "    b.[NO INTERVENANT GRP] = IIf(t.[NO INTERVENANT GRP] Is Null, f.[NO INTERVENANT GRP], t.[NO INTERVENANT GRP]);"
    
    ' === 4) DepassementNA ===
    ' Today présent -> calcule directement
    cn.Execute _
      "UPDATE " & T_CLOSE & " b INNER JOIN " & T_TODAY & " t " & _
      "ON b.Booking=t.Booking AND b.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET b.DepassementNA = IIf(Abs(t.Consommation) > t.Limite, 'YES','NO');"
    
    ' Today absent -> hérite de FLUX (corrigé: AND et pas ET)
    cn.Execute _
      "UPDATE (" & T_CLOSE & " b INNER JOIN " & T_FLUX & " f ON b.Booking=f.Booking AND b.[NO DOSSIER CREDIT]=f.[NO DOSSIER CREDIT]) " & _
      "LEFT JOIN " & T_TODAY & " t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET b.DepassementNA = IIf(Abs(f.Consommation) > f.Limite, 'YES','NO') " & _
      "WHERE t.Booking IS NULL;"
    
    ' =====================================================================
    ' 5) [DÉSACTIVÉ] Chevauchements via T_HIST (ne PAS activer si on veut
    '    que les flags décrivent UNIQUEMENT ce qui SE FERME aujourd’hui)
    ' ---------------------------------------------------------------------
    '
    ' ' VG -> AM/SL
    ' cn.Execute _
    '   "UPDATE " & T_CLOSE & " AS b SET b.FlagAM='YES' " & _
    '   "WHERE b.FlagVG='YES' AND EXISTS (" & _
    '   "  SELECT 1 FROM " & T_HIST & " h " & _
    '   "  WHERE h.Booking=b.Booking AND h.[NO DOSSIER CREDIT]=b.[NO DOSSIER CREDIT] AND h.Nature='AM' " & _
    '   "    AND h.[Production Date] BETWEEN b.VG_StartDate AND b.VG_EndDate AND h.Insuffisance < 0);"
    '
    ' cn.Execute _
    '   "UPDATE " & T_CLOSE & " AS b SET b.FlagSL='YES' " & _
    '   "WHERE b.FlagVG='YES' AND EXISTS (" & _
    '   "  SELECT 1 FROM " & T_HIST & " h " & _
    '   "  WHERE h.Booking=b.Booking AND h.[NO DOSSIER CREDIT]=b.[NO DOSSIER CREDIT] AND h.Nature='SL' " & _
    '   "    AND h.[Production Date] BETWEEN b.VG_StartDate AND b.VG_EndDate AND h.Insuffisance < 0);"
    '
    ' ' AM -> VG/SL
    ' cn.Execute _
    '   "UPDATE " & T_CLOSE & " AS b SET b.FlagVG='YES' " & _
    '   "WHERE b.FlagAM='YES' AND EXISTS (" & _
    '   "  SELECT 1 FROM " & T_HIST & " h " & _
    '   "  WHERE h.Booking=b.Booking AND h.[NO DOSSIER CREDIT]=b.[NO DOSSIER CREDIT] AND h.Nature='VG' " & _
    '   "    AND h.[Production Date] BETWEEN b.AM_StartDate AND b.AM_EndDate AND h.Insuffisance < 0);"
    '
    ' cn.Execute _
    '   "UPDATE " & T_CLOSE & " AS b SET b.FlagSL='YES' " & _
    '   "WHERE b.FlagAM='YES' AND EXISTS (" & _
    '   "  SELECT 1 FROM " & T_HIST & " h " & _
    '   "  WHERE h.Booking=b.Booking AND h.[NO DOSSIER CREDIT]=b.[NO DOSSIER CREDIT] AND h.Nature='SL' " & _
    '   "    AND h.[Production Date] BETWEEN b.AM_StartDate AND b.AM_EndDate AND h.Insuffisance < 0);"
    '
    ' ' SL -> VG/AM
    ' cn.Execute _
    '   "UPDATE " & T_CLOSE & " AS b SET b.FlagVG='YES' " & _
    '   "WHERE b.FlagSL='YES' AND EXISTS (" & _
    '   "  SELECT 1 FROM " & T_HIST & " h " & _
    '   "  WHERE h.Booking=b.Booking AND h.[NO DOSSIER CREDIT]=b.[NO DOSSIER CREDIT] AND h.Nature='VG' " & _
    '   "    AND h.[Production Date] BETWEEN b.SL_StartDate AND b.SL_EndDate AND h.Insuffisance < 0);"
    '
    ' cn.Execute _
    '   "UPDATE " & T_CLOSE & " AS b SET b.FlagAM='YES' " & _
    '   "WHERE b.FlagSL='YES' AND EXISTS (" & _
    '   "  SELECT 1 FROM " & T_HIST & " h " & _
    '   "  WHERE h.Booking=b.Booking AND h.[NO DOSSIER CREDIT]=b.[NO DOSSIER CREDIT] AND h.Nature='AM' " & _
    '   "    AND h.[Production Date] BETWEEN b.SL_StartDate AND b.SL_EndDate AND h.Insuffisance < 0);"
    ' =====================================================================
    
End Sub

Private Sub BuildCloseBufferXXXX(ByVal cn As Object)

    cn.Execute "DELETE FROM " & T_CLOSE
    
    ' Clés à clôturer si AU MOINS une nature se ferme
    cn.Execute _
      "INSERT INTO " & T_CLOSE & " (Booking, [NO DOSSIER CREDIT]) " & _
      "SELECT DISTINCT f.Booking, f.[NO DOSSIER CREDIT] " & _
      "FROM " & T_FLUX & " AS f " & _
      "LEFT JOIN " & T_TODAY & " AS t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "WHERE (f.VG_StartDate IS NOT NULL AND (t.Booking IS NULL OR t.[Insuffisance VG] >= 0)) " & _
      "   OR (f.AM_StartDate IS NOT NULL AND (t.Booking IS NULL OR t.[Insuffisance AM] >= 0)) " & _
      "   OR (f.SL_StartDate IS NOT NULL AND (t.Booking IS NULL OR t.[Insuffisance SL] >= 0));"
    
    ' --- VG ---
    cn.Execute _
      "UPDATE (" & T_CLOSE & " b INNER JOIN " & T_FLUX & " f ON b.Booking=f.Booking AND b.[NO DOSSIER CREDIT]=f.[NO DOSSIER CREDIT]) " & _
      "LEFT JOIN " & T_TODAY & " t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET b.VG_StartDate=f.VG_StartDate, b.VG_Duree=f.VG_NbJoursRetard, " & _
      "    b.VG_WorstInsuffisance=f.VG_WorstInsuffisance, b.VG_DateWorstInsuffisance=f.VG_DateWorstInsuffisance, " & _
      "    b.VG_LastInsuffisance=f.VG_LastInsuffisance, b.VG_LastUpdateDate=f.VG_LastUpdateDate, b.FlagVG='YES', " & _
      "    b.VG_EndDate=IIf(t.Booking Is Null, f.VG_LastUpdateDate, t.[Production Date]) " & _
      "WHERE f.VG_StartDate IS NOT NULL AND (t.Booking IS NULL OR t.[Insuffisance VG] >= 0);"
    
    ' --- AM ---
    cn.Execute _
      "UPDATE (" & T_CLOSE & " b INNER JOIN " & T_FLUX & " f ON b.Booking=f.Booking AND b.[NO DOSSIER CREDIT]=f.[NO DOSSIER CREDIT]) " & _
      "LEFT JOIN " & T_TODAY & " t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET b.AM_StartDate=f.AM_StartDate, b.AM_Duree=f.AM_NbJoursRetard, " & _
      "    b.AM_WorstInsuffisance=f.AM_WorstInsuffisance, b.AM_DateWorstInsuffisance=f.AM_DateWorstInsuffisance, " & _
      "    b.AM_LastInsuffisance=f.AM_LastInsuffisance, b.AM_LastUpdateDate=f.AM_LastUpdateDate, b.FlagAM='YES', " & _
      "    b.AM_EndDate=IIf(t.Booking Is Null, f.AM_LastUpdateDate, t.[Production Date]) " & _
      "WHERE f.AM_StartDate IS NOT NULL AND (t.Booking IS NULL OR t.[Insuffisance AM] >= 0);"
    
    ' --- SL ---
    cn.Execute _
      "UPDATE (" & T_CLOSE & " b INNER JOIN " & T_FLUX & " f ON b.Booking=f.Booking AND b.[NO DOSSIER CREDIT]=f.[NO DOSSIER CREDIT]) " & _
      "LEFT JOIN " & T_TODAY & " t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET b.SL_StartDate=f.SL_StartDate, b.SL_Duree=f.SL_NbJoursRetard, " & _
      "    b.SL_WorstInsuffisance=f.SL_WorstInsuffisance, b.SL_DateWorstInsuffisance=f.SL_DateWorstInsuffisance, " & _
      "    b.SL_LastInsuffisance=f.SL_LastInsuffisance, b.SL_LastUpdateDate=f.SL_LastUpdateDate, b.FlagSL='YES', " & _
      "    b.SL_EndDate=IIf(t.Booking Is Null, f.SL_LastUpdateDate, t.[Production Date]) " & _
      "WHERE f.SL_StartDate IS NOT NULL AND (t.Booking IS NULL OR t.[Insuffisance SL] >= 0);"
    
    ' Champs communs (Today si présent, sinon Flux) — sans Nz
    cn.Execute _
      "UPDATE (" & T_CLOSE & " b INNER JOIN " & T_FLUX & " f ON b.Booking=f.Booking AND b.[NO DOSSIER CREDIT]=f.[NO DOSSIER CREDIT]) " & _
      "LEFT JOIN " & T_TODAY & " t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET b.Limite = IIf(t.Limite Is Null, f.Limite, t.Limite), " & _
      "    b.Consommation = IIf(t.Consommation Is Null, f.Consommation, t.Consommation), " & _
      "    b.[Montant VG] = IIf(t.[Montant VG] Is Null, f.[Montant VG], t.[Montant VG]), " & _
      "    b.[Montant AM] = IIf(t.[Montant AM] Is Null, f.[Montant AM], t.[Montant AM]), " & _
      "    b.[Montant SL] = IIf(t.[Montant SL] Is Null, f.[Montant SL], t.[Montant SL]), " & _
      "    b.[Production Date] = IIf(t.[Production Date] Is Null, f.[Production Date], t.[Production Date]), " & _
      "    b.[NO INTERVENANT] = IIf(t.[NO INTERVENANT] Is Null, f.[NO INTERVENANT], t.[NO INTERVENANT]), " & _
      "    b.[NO INTERVENANT GRP] = IIf(t.[NO INTERVENANT GRP] Is Null, f.[NO INTERVENANT GRP], t.[NO INTERVENANT GRP]);"
    
    ' DepassementNA (Today dispo) — on met à jour sans Nz
    cn.Execute _
      "UPDATE " & T_CLOSE & " b INNER JOIN " & T_TODAY & " t " & _
      "ON b.Booking=t.Booking AND b.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET b.DepassementNA = IIf(Abs(t.Consommation) > t.Limite, 'YES','NO');"
    
    ' DepassementNA hérité de Flux quand Today absent (corrigé AND)
    cn.Execute _
      "UPDATE (" & T_CLOSE & " b INNER JOIN " & T_FLUX & " f ON b.Booking=f.Booking AND b.[NO DOSSIER CREDIT]=f.[NO DOSSIER CREDIT]) " & _
      "LEFT JOIN " & T_TODAY & " t ON f.Booking=t.Booking AND f.[NO DOSSIER CREDIT]=t.[NO DOSSIER CREDIT] " & _
      "SET b.DepassementNA = IIf(Abs(f.Consommation) > f.Limite, 'YES','NO') " & _
      "WHERE t.Booking IS NULL;"
    
    ' ===== Chevauchements via T_HIST (calcul des Flags dans le buffer) =====
    ' VG -> AM/SL
    cn.Execute _
      "UPDATE " & T_CLOSE & " AS b SET b.FlagAM='YES' " & _
      "WHERE b.FlagVG='YES' AND EXISTS (" & _
      "  SELECT 1 FROM " & T_HIST & " h " & _
      "  WHERE h.Booking=b.Booking AND h.[NO DOSSIER CREDIT]=b.[NO DOSSIER CREDIT] AND h.Nature='AM' " & _
      "    AND h.[Production Date] BETWEEN b.VG_StartDate AND b.VG_EndDate AND h.Insuffisance < 0);"
    
    cn.Execute _
      "UPDATE " & T_CLOSE & " AS b SET b.FlagSL='YES' " & _
      "WHERE b.FlagVG='YES' AND EXISTS (" & _
      "  SELECT 1 FROM " & T_HIST & " h " & _
      "  WHERE h.Booking=b.Booking AND h.[NO DOSSIER CREDIT]=b.[NO DOSSIER CREDIT] AND h.Nature='SL' " & _
      "    AND h.[Production Date] BETWEEN b.VG_StartDate AND b.VG_EndDate AND h.Insuffisance < 0);"
    
    ' AM -> VG/SL
    cn.Execute _
      "UPDATE " & T_CLOSE & " AS b SET b.FlagVG='YES' " & _
      "WHERE b.FlagAM='YES' AND EXISTS (" & _
      "  SELECT 1 FROM " & T_HIST & " h " & _
      "  WHERE h.Booking=b.Booking AND h.[NO DOSSIER CREDIT]=b.[NO DOSSIER CREDIT] AND h.Nature='VG' " & _
      "    AND h.[Production Date] BETWEEN b.AM_StartDate AND b.AM_EndDate AND h.Insuffisance < 0);"
    
    cn.Execute _
      "UPDATE " & T_CLOSE & " AS b SET b.FlagSL='YES' " & _
      "WHERE b.FlagAM='YES' AND EXISTS (" & _
      "  SELECT 1 FROM " & T_HIST & " h " & _
      "  WHERE h.Booking=b.Booking AND h.[NO DOSSIER CREDIT]=b.[NO DOSSIER CREDIT] AND h.Nature='SL' " & _
      "    AND h.[Production Date] BETWEEN b.AM_StartDate AND b.AM_EndDate AND h.Insuffisance < 0);"
    
    ' SL -> VG/AM
    cn.Execute _
      "UPDATE " & T_CLOSE & " AS b SET b.FlagVG='YES' " & _
      "WHERE b.FlagSL='YES' AND EXISTS (" & _
      "  SELECT 1 FROM " & T_HIST & " h " & _
      "  WHERE h.Booking=b.Booking AND h.[NO DOSSIER CREDIT]=b.[NO DOSSIER CREDIT] AND h.Nature='VG' " & _
      "    AND h.[Production Date] BETWEEN b.SL_StartDate AND b.SL_EndDate AND h.Insuffisance < 0);"
    
    cn.Execute _
      "UPDATE " & T_CLOSE & " AS b SET b.FlagAM='YES' " & _
      "WHERE b.FlagSL='YES' AND EXISTS (" & _
      "  SELECT 1 FROM " & T_HIST & " h " & _
      "  WHERE h.Booking=b.Booking AND h.[NO DOSSIER CREDIT]=b.[NO DOSSIER CREDIT] AND h.Nature='AM' " & _
      "    AND h.[Production Date] BETWEEN b.SL_StartDate AND b.SL_EndDate AND h.Insuffisance < 0);"
      
End Sub

Private Function InsertCloseBufferToArchive(ByVal cn As Object) As Long 'Insertion du buffer vers l’archive (une seule passe)
    
    cn.Execute _
      "INSERT INTO " & T_ARC & " (" & _
      "  Booking, [NO DOSSIER CREDIT], " & _
      "  VG_StartDate, VG_EndDate, VG_Duree, VG_WorstInsuffisance, VG_DateWorstInsuffisance, VG_LastInsuffisance, VG_LastUpdateDate, " & _
      "  AM_StartDate, AM_EndDate, AM_Duree, AM_WorstInsuffisance, AM_DateWorstInsuffisance, AM_LastInsuffisance, AM_LastUpdateDate, " & _
      "  SL_StartDate, SL_EndDate, SL_Duree, SL_WorstInsuffisance, SL_DateWorstInsuffisance, SL_LastInsuffisance, SL_LastUpdateDate, " & _
      "  Limite, Consommation, [Montant VG], [Montant AM], [Montant SL], [Production Date], [NO INTERVENANT], [NO INTERVENANT GRP], " & _
      "  DepassementNA, FlagVG, FlagAM, FlagSL" & _
      ") " & _
      "SELECT " & _
      "  b.Booking, b.[NO DOSSIER CREDIT], " & _
      "  b.VG_StartDate, b.VG_EndDate, b.VG_Duree, b.VG_WorstInsuffisance, b.VG_DateWorstInsuffisance, b.VG_LastInsuffisance, b.VG_LastUpdateDate, " & _
      "  b.AM_StartDate, b.AM_EndDate, b.AM_Duree, b.AM_WorstInsuffisance, b.AM_DateWorstInsuffisance, b.AM_LastInsuffisance, b.AM_LastUpdateDate, " & _
      "  b.SL_StartDate, b.SL_EndDate, b.SL_Duree, b.SL_WorstInsuffisance, b.SL_DateWorstInsuffisance, b.SL_LastInsuffisance, b.SL_LastUpdateDate, " & _
      "  b.Limite, b.Consommation, b.[Montant VG], b.[Montant AM], b.[Montant SL], b.[Production Date], b.[NO INTERVENANT], b.[NO INTERVENANT GRP], " & _
      "  b.DepassementNA, b.FlagVG, b.FlagAM, b.FlagSL " & _
      "FROM " & T_CLOSE & " b;"
    
    InsertCloseBufferToArchive = RecordsAffected(cn) 'cn.RecordsAffected
    
End Function


